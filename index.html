<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58200086-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58200086-6');
</script>
<!-- End Google Analytics -->

  
  <title>龙天的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="龙天的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="龙天的博客">
<meta property="og:url" content="https://blog.longtian.io/index.html">
<meta property="og:site_name" content="龙天的博客">
<meta property="og:description" content="龙天的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="longtian">
<meta property="article:tag" content="技术博客">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="龙天的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">龙天的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">大前端，DevOps，敏捷开发</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.longtian.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-my-first-commit-to-alpine" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/01/my-first-commit-to-alpine.html" class="article-date">
  <time class="dt-published" datetime="2024-04-30T16:00:00.000Z" itemprop="datePublished">2024-05-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/01/my-first-commit-to-alpine.html">我的第一个 Alpine OS Commit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近特别爱用 Alpine OS， 试着在上面使用 K3S 搭建一个 Kubernetes 集群。</p>
<p>当时使用的版本是 <code>Alpine v3.19</code> ，包管理器里自带的 Kubernetes 版本是 <code>k3s-1.28.8.1-r1</code>，安装过程没有报错，但是启动的时候有一个 <code>Fatal Error</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time=<span class="string">&quot;2024-04-10T00:58:17+08:00&quot;</span> level=fatal msg=<span class="string">&quot;Failed to validate golang version: kubernetes golang build version not set - see &#x27;golang: upstream version&#x27; in https://github.com/kubernetes/kubernetes/blob/v1.28.8/build/dependencies.yaml&quot;</span></span><br></pre></td></tr></table></figure>

<p>之后定位到是 Alpine OS 包管理器没有及时同步上游的改动的问题，看到有人已经在 <code>Edge</code> 频道里修复了 <a target="_blank" rel="noopener" href="https://gitlab.alpinelinux.org/alpine/aports/-/issues/15748">#15748</a>，我就基于这个改动，在 <code>Community</code> 频道里也修复了 <a target="_blank" rel="noopener" href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/63824">#63824</a></p>
        
          <p class="article-more-link">
            <a href="/2024/05/01/my-first-commit-to-alpine.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2024/05/01/my-first-commit-to-alpine.html" data-id="cm0177moe00173kq6aew4fgok" data-title="我的第一个 Alpine OS Commit" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/alpine/" rel="tag">alpine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/devops/" rel="tag">devops</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-new-baby" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/27/new-baby.html" class="article-date">
  <time class="dt-published" datetime="2023-12-27T03:00:00.000Z" itemprop="datePublished">2023-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>几天绝对是一个值得纪念的日子 :)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Baby</span>()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2023/12/27/new-baby.html" data-id="cm0177moe00163kq67a4j4hu1" data-title="" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-reading-2022" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/21/reading-2022.html" class="article-date">
  <time class="dt-published" datetime="2022-06-21T03:23:16.000Z" itemprop="datePublished">2022-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今年上半年突然多了很多时间看书，先把以前囤的纸质书翻了翻，后来又买了一个华为出品的墨水屏，立刻荣升阅读主力。<br>总的来说搭配微信阅读 App 的付费会员还是比较省钱的，预计今年底就能回本。</p>
        
          <p class="article-more-link">
            <a href="/2022/06/21/reading-2022.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/06/21/reading-2022.html" data-id="cm0177moj001o3kq677kceyp7" data-title="我的 2022 书单" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-how-gps-work" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/11/how-gps-work.html" class="article-date">
  <time class="dt-published" datetime="2022-02-11T10:09:40.000Z" itemprop="datePublished">2022-02-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前订阅了 ciechanowski 大神的博客，虽然更新不频繁（一年几篇）但是每一篇都属于精品。大神总是能结合前端可视化技术把一些天文、物理什么的知识点讲解的很透彻。</p>
<p><a target="_blank" rel="noopener" href="https://ciechanow.ski/gps/">GPS</a> 这篇文章刚发布没几天我就注意到了，赶紧拜读了一下。从三角定位讲到相对论再到卫星信号的编解码，内容非常详实，交互动画的制作精美无比可以说是教案水准。</p>
<p>因为某些原因，2022 这个春节能够在家待上好长一阵子。所以我就利用这个机会前后花了大概 10 天时间把这篇文章翻译成了 <a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">中文版</a>，希望能够对所有对 GPS 工作原理感兴趣的朋友带来帮助。</p>
<h3 id="文章地址"><a href="#文章地址" class="headerlink" title="文章地址"></a>文章地址</h3><p><a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">pages.longtian.info&#x2F;gps</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/02/11/how-gps-work.html" data-id="cm0177mo5000f3kq6bxq52990" data-title="[译] GPS 工作原理的可视化" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-different-image-digest-in-console-and-on-hub" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html" class="article-date">
  <time class="dt-published" datetime="2021-11-25T03:48:29.000Z" itemprop="datePublished">2021-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/25/different-image-digest-in-console-and-on-hub.html">为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个问题困扰自己很久了，今天终于搞明白了。</p>
<p>复现： 在 Docker Hub 查看 alpine 的镜像信息，并在主机上执行 <code>docker pull alpine:3.12</code><br>问题： 在网站上看到的 <code>Digest</code> 和控制台里显示的 <code>Digest</code> 不一样</p>
<p>控制台显示的 <code>Digest</code> 是 <code>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3.12: Pulling from library/alpine</span><br><span class="line">Digest: sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</span><br><span class="line">Status: Image is up to <span class="built_in">date</span> <span class="keyword">for</span> alpine:3.12</span><br><span class="line">docker.io/library/alpine:3.12</span><br></pre></td></tr></table></figure>

<p>这个 <code>Digest</code> 并不在 alpine:3.12 官方仓库对应不同平台的<a target="_blank" rel="noopener" href="https://hub.docker.com/_/alpine?tab=tags&page=1&name=3.12">镜像列表</a> 里</p>
<table>
<thead>
<tr>
<th>DIGEST</th>
<th>OS&#x2F;ARCH</th>
<th>COMPRESSED SIZE</th>
</tr>
</thead>
<tbody><tr>
<td>7893969ec350</td>
<td>linux&#x2F;386</td>
<td>2.67 MB</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://hub.docker.com/layers/alpine/library/alpine/3.12/images/sha256-74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18">74e5ad84a67e</a></td>
<td>linux&#x2F;amd64</td>
<td>2.68 MB</td>
</tr>
<tr>
<td>8a6e4b2093ee</td>
<td>linux&#x2F;arm&#x2F;v6</td>
<td>2.49 MB</td>
</tr>
<tr>
<td>45a18fc6f681</td>
<td>linux&#x2F;arm&#x2F;v7</td>
<td>2.31 MB</td>
</tr>
<tr>
<td>29ba524fa7f5</td>
<td>linux&#x2F;arm64&#x2F;v8</td>
<td>2.59 MB</td>
</tr>
<tr>
<td>08340ab4a605</td>
<td>linux&#x2F;ppc64le</td>
<td>2.69 MB</td>
</tr>
<tr>
<td>9a7276e7579f</td>
<td>linux&#x2F;s390x</td>
<td>2.46 MB</td>
</tr>
</tbody></table>
<p>那么这两个 <code>Digest</code>，到底以那个为准呢</p>
<ul>
<li>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</li>
<li>74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/11/25/different-image-digest-in-console-and-on-hub.html" data-id="cm0177mo000053kq645pp742w" data-title="为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-kubernetes-resources" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/12/kubernetes-resources.html" class="article-date">
  <time class="dt-published" datetime="2021-07-12T03:27:21.000Z" itemprop="datePublished">2021-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/12/kubernetes-resources.html">Kubernetes 资源分配</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近遇到了 Kubernetes 上的 Web 应用响应时间长尾的问题，上网收集资料，分析了一下原因。</p>
<ul>
<li>CGroup 节流导致 Web 请求相应时间增加</li>
<li>当前执行的 CPU 不断变动</li>
<li>核数越多 CGroup 补偿碎片越严重</li>
<li>跨越 NUMA 节点</li>
</ul>
<h2 id="请求和限制计算资源"><a href="#请求和限制计算资源" class="headerlink" title="请求和限制计算资源"></a>请求和限制计算资源</h2><p>Kubernetes 对资源的细粒度管理功能可以说是吸引传统应用上 Kubernetes 的重要原因之一</p>
<p>我们在定义 Pod 的时候通过以下两个字段可以控制计算资源的分配：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests</code></td>
<td>请求的最少资源</td>
</tr>
<tr>
<td><code>limits</code></td>
<td>资源限制</td>
</tr>
</tbody></table>
<ul>
<li>当 <code>requests</code> 无法满足时，<code>Pod</code> 会一直停在 <code>Pending</code> 状态，触发 <code>FailedScheduling</code> 事件</li>
<li>当使用内存资源超过 <code>limits</code> 时，如果有其他 POD 需要内存，则使用内存最多的容器会被 <code>sacrifice</code>，触发 <code>OOMKilled</code> 事件</li>
<li>如果不指定 <code>limits</code> , 在没有命名空间默认值的情况下可以无限制地使用资源</li>
<li>如果指定了 <code>limits</code> , 但是没有指定 <code>requests</code> , 则 <code>requests</code> 值默认为 <code>limits</code> 值</li>
<li>从分配角度讲 <code>CPU</code> 属于可以压缩的资源、内存属于不可以压缩的资源</li>
</ul>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mem-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;150M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="命名空间默认值、最小值和最大值"><a href="#命名空间默认值、最小值和最大值" class="headerlink" title="命名空间默认值、最小值和最大值"></a>命名空间默认值、最小值和最大值</h2><p>有些 Kubernetes 集群环境下会出现这样的问题：定义 Pod 的时候明明没有给计算资源的限制，但是在实际运行的 Pod 上出现了资源限制的定义。</p>
<p>这很有可能是命名空间的默认值造成的。 通过 <code>LimitRange</code> 对象可以设置命名空间资源的默认值、最小值和最大值。</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>default</td>
<td><code>limit</code></td>
</tr>
<tr>
<td>defaultRequest</td>
<td><code>request</code></td>
</tr>
<tr>
<td>min</td>
<td>最小值</td>
</tr>
<tr>
<td>max</td>
<td>最大值</td>
</tr>
<tr>
<td>maxLimitRequestRatio</td>
<td>比率</td>
</tr>
<tr>
<td>type</td>
<td>对象</td>
</tr>
</tbody></table>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">mem-min-max-demo-lr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod-服务质量"><a href="#Pod-服务质量" class="headerlink" title="Pod 服务质量"></a>Pod 服务质量</h2><p>当系统资源不足时就会有 Pod 遭殃，但是那么多 Pod 怎么知道要干掉哪一个呢。这就和 Pod 的服务质量有关。</p>
<p>查看运行中的 <code>Pod</code> 会有一个 <code>qosClass</code> 字段，它有以下三种取值：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Guaranteed</td>
<td>被保证的，优先级最高，除非超过限制不然不会被干掉</td>
</tr>
<tr>
<td>Burstable</td>
<td>允许突发，位于中间, 当系统资源不足且没有 <code>Best-Effort</code> 级别时</td>
</tr>
<tr>
<td>BestEffort</td>
<td>尽力保证，优先级最低，当系统资源不足时最先被干掉</td>
</tr>
</tbody></table>
<p>需要注意 <code>qosClass</code> 的值无法直接设置，而是通过 <code>requests</code> 和 <code>limits</code> 组合隐式设置</p>
<h3 id="Guaranteed"><a href="#Guaranteed" class="headerlink" title="Guaranteed"></a>Guaranteed</h3><ul>
<li>Pod 中的每个容器都要指定 CPU 请求和限制，并且两者相等</li>
<li>Pod 中的每个容器都要指定内存请求和限制，并且两者相等</li>
</ul>
<h3 id="Burstable"><a href="#Burstable" class="headerlink" title="Burstable"></a>Burstable</h3><ul>
<li>Pod 不符合 Guaranteed QoS 类的标准</li>
<li>Pod 至少有一个容器具有 CPU 或内存请求</li>
</ul>
<h3 id="BestEffort"><a href="#BestEffort" class="headerlink" title="BestEffort"></a>BestEffort</h3><ul>
<li>没有 CPU、内存请求和限制</li>
</ul>
<h2 id="CPU-管理策略"><a href="#CPU-管理策略" class="headerlink" title="CPU 管理策略"></a>CPU 管理策略</h2><p>在现代操作系统的设计下，负载运行可能会不断地迁移到不同的 CPU 核心，Kubernetes 上也是一样。</p>
<p>Kubernetes 提供了 CPU 管理策略来实现负载和 CPU 核的绑定。</p>
<p>通过 kubelet 参数 <code>--cpu-manager-policy</code> 来指定 CPU 管理策略。</p>
<table>
<thead>
<tr>
<th>取值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>none</td>
<td>默认策略，按照 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E5%85%AC%E5%B9%B3%E6%8E%92%E7%A8%8B%E5%99%A8">CFS</a> 来执行调度</td>
</tr>
<tr>
<td>static</td>
<td>允许为节点上具有某些资源特征的 Pod 赋予增强的 CPU 亲和性和独占性</td>
</tr>
</tbody></table>
<p>为了将 Pod 绑定到 CPU 需要</p>
<ul>
<li>Kubelet 开启 <code>--cpu-manager-policy static</code></li>
<li>Pod 的服务优先级为 <code>Guaranteed</code></li>
<li>Pod 的 CPU 资源为整数</li>
</ul>
<p>例如，下面的 Nginx Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br></pre></td></tr></table></figure>

<p>在运行时可独占两颗 CPU</p>
<h2 id="NUMA-和拓扑管理策略"><a href="#NUMA-和拓扑管理策略" class="headerlink" title="NUMA 和拓扑管理策略"></a>NUMA 和拓扑管理策略</h2><p>NUMA 是系统优化的一个常用思路，它是伴随着多处理器出现的一个问题。</p>
<blockquote>
<p>非统一内存访问架构（英语：Non-uniform memory access，简称NUMA）是一种为多处理器的电脑设计的内存架构，内存访问时间取决于内存相对于处理器的位置。</p>
</blockquote>
<p>常见的硬件有</p>
<ul>
<li>CPU</li>
<li>Memory</li>
<li>GPU</li>
<li>NIC</li>
</ul>
<p>安装 <code>numactl</code> 后可以通过下面的命令查看主机的 NUMA 相关信息</p>
<p><code>numactl --harware</code></p>
<p>通过下面的命令查看 NUMA 的统计信息</p>
<p><code>numastat</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">numa_hit       | Number of pages allocated from the node the process wanted.</span><br><span class="line">numa_miss      | Number of pages allocated from this node, but the process preferred another node.</span><br><span class="line">numa_foreign   | Number of pages allocated another node, but the process preferred this node.</span><br><span class="line">local_node     | Number of pages allocated from this node while the process was running locally.</span><br><span class="line">other_node     | Number of pages allocated from this node while the process was running remotely (on another node).</span><br><span class="line">interleave_hit | Number of pages allocated successfully with the interleave strategy.</span><br></pre></td></tr></table></figure>

<p>以上指标均可以通过 Telegraf 监控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.kernel_vmstat]]</span><br></pre></td></tr></table></figure>

<p><code>--cpu-manager-policy static --topology-manager-scope pod --topology-manager-policy single-numa-node</code></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/">https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/">https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/">https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/07/12/kubernetes-resources.html" data-id="cm0177mo8000t3kq6ag432z2o" data-title="Kubernetes 资源分配" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-istio-response-flags" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/21/istio-response-flags.html" class="article-date">
  <time class="dt-published" datetime="2021-04-21T07:40:35.000Z" itemprop="datePublished">2021-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/21/istio-response-flags.html">Istio 请求响应标志</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>整理了一下 Istio 的 Response Flags</p>
<p><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-response-flags">介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy/blob/v1.18.2/source/common/stream_info/utility.h#L21">源码</a></p>
<table>
<thead>
<tr>
<th>协议</th>
<th>缩写</th>
<th>备注</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP</td>
<td>DC</td>
<td>DOWNSTREAM_CONNECTION_TERMINATION</td>
<td>Downstream connection termination.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DI</td>
<td>DELAY_INJECTED</td>
<td>The request processing was delayed for a period specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DPE</td>
<td>DOWNSTREAM_PROTOCOL_ERROR</td>
<td>The downstream request had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>FI</td>
<td>FAULT_INJECTED</td>
<td>The request was aborted with a response code specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>IH</td>
<td>INVALID_ENVOY_REQUEST_HEADERS</td>
<td>The request was rejected because it set an invalid value for a strictly-checked header in addition to 400 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LH</td>
<td>FAILED_LOCAL_HEALTH_CHECK</td>
<td>Local service failed health check request in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LR</td>
<td>LOCAL_RESET</td>
<td>Connection local reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NC</td>
<td>NO_CLUSTER_FOUND</td>
<td>Upstream cluster not found.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NR</td>
<td>NO_ROUTE_FOUND</td>
<td>No route configured for a given request in addition to 404 response code, or no matching filter chain for a downstream connection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RL</td>
<td>RATE_LIMITED</td>
<td>The request was ratelimited locally by the HTTP rate limit filter in addition to 429 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RLSE</td>
<td>RATELIMIT_SERVICE_ERROR</td>
<td>The request was rejected because there was an error in rate limit service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>SI</td>
<td>STREAM_IDLE_TIMEOUT</td>
<td>Stream idle timeout in addition to 408 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UAEX</td>
<td>UNAUTHORIZED_EXTERNAL_SERVICE</td>
<td>The request was denied by the external authorization service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UC</td>
<td>UPSTREAM_CONNECTION_TERMINATION</td>
<td>Upstream connection termination in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UF</td>
<td>UPSTREAM_CONNECTION_FAILURE</td>
<td>Upstream connection failure in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UH</td>
<td>NO_HEALTHY_UPSTREAM</td>
<td>No healthy upstream hosts in upstream cluster in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UMSDR</td>
<td>UPSTREAM_MAX_STREAM_DURATION_REACHED</td>
<td>The upstream request reached to max stream duration.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UO</td>
<td>UPSTREAM_OVERFLOW</td>
<td>Upstream overflow (circuit breaking) in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UPE</td>
<td>UPSTREAM_PROTOCOL_ERROR</td>
<td>The upstream response had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UR</td>
<td>UPSTREAM_REMOTE_RESET</td>
<td>Upstream remote reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>URX</td>
<td>UPSTREAM_RETRY_LIMIT_EXCEEDED</td>
<td>The request was rejected because the upstream retry limit (HTTP) or maximum connect attempts (TCP) was reached.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UT</td>
<td>UPSTREAM_REQUEST_TIMEOUT</td>
<td>Upstream request timeout in addition to 504 response code.</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/21/istio-response-flags.html" data-id="cm0177mo7000n3kq6gccjg5mz" data-title="Istio 请求响应标志" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/istio/" rel="tag">istio</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-containerized-jvm-parameters" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/13/containerized-jvm-parameters.html" class="article-date">
  <time class="dt-published" datetime="2021-04-13T09:23:31.000Z" itemprop="datePublished">2021-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/13/containerized-jvm-parameters.html">JVM 对容器化支持的参数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>阅读本文你需要了解</p>
<ul>
<li>JVM 的启动参数</li>
<li>容器的启动参数</li>
</ul>
<h3 id="JVM-启动参数"><a href="#JVM-启动参数" class="headerlink" title="JVM 启动参数"></a>JVM 启动参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>-Xms</code></td>
<td>MiniumHeapSize</td>
</tr>
<tr>
<td><code>-Xmx</code></td>
<td>MaxHeapSize</td>
</tr>
<tr>
<td><code>-Xss</code></td>
<td>StackSize</td>
</tr>
</tbody></table>
<p>在容器化之前一般由运维工程师根据部署环境机器的内存大小来调整，并写在启动脚本里</p>
<h3 id="容器启动参数"><a href="#容器启动参数" class="headerlink" title="容器启动参数"></a>容器启动参数</h3><p>在使用 k8s 编排容器的时候通常通过定义 resources 字段来限制容器使用的资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limit:</span></span><br><span class="line">     <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">     <span class="attr">memory:</span> <span class="string">1G</span></span><br></pre></td></tr></table></figure>

<p>为了方便验证，我们直接用本地 docker 来实验，docker run 命令的一些参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>–cpus</td>
<td>Number of CPUs</td>
</tr>
<tr>
<td>–cpu-period int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) period</td>
</tr>
<tr>
<td>–cpu-quota int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) quota</td>
</tr>
<tr>
<td>–cpu-rt-period int</td>
<td>Limit CPU real-time period in microseconds</td>
</tr>
<tr>
<td>–cpu-rt-runtime int</td>
<td>Limit CPU real-time runtime in microseconds</td>
</tr>
<tr>
<td>–cpu-shares int</td>
<td>CPU shares (relative weight)</td>
</tr>
<tr>
<td>–memory</td>
<td>Memory limit</td>
</tr>
</tbody></table>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>容器化的 JVM 程序会遇到这几个问题</p>
<ul>
<li>问题 1： 超过了容器的资源限制被 OOM 机制杀掉</li>
<li>问题 2： 在核数比较高的机器上 JVM 频繁 GC</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2021/04/13/containerized-jvm-parameters.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/13/containerized-jvm-parameters.html" data-id="cm0177mnz00033kq6f80zfyhj" data-title="JVM 对容器化支持的参数" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tencentyun" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/18/tencentyun.html" class="article-date">
  <time class="dt-published" datetime="2021-03-18T05:28:28.000Z" itemprop="datePublished">2021-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="腾讯-Centos-软件源的使用"><a href="#腾讯-Centos-软件源的使用" class="headerlink" title="腾讯 Centos 软件源的使用"></a>腾讯 Centos 软件源的使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo</span><br><span class="line">sed -i &#x27;s/cloud\.tencent\.com/tencentyun\.com/1&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/03/18/tencentyun.html" data-id="cm0177mom00243kq6hsqgdv9e" data-title="" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-letsencrypt-root-ca" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/18/letsencrypt-root-ca.html" class="article-date">
  <time class="dt-published" datetime="2020-09-18T05:22:00.000Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/18/letsencrypt-root-ca.html">[译] Let&#39;s Encrypt 的新根证书和中间证书</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://letsencrypt.org/2020/09/17/new-root-and-intermediates.html">原文</a></p>
<p>在 2020 年 9 月 30 日这天，Let’s Encrypt 颁发了六个新证书：一个根证书，四个中间证书和一个交叉证书。这些证书属于改善网络隐私的更大计划的一部分，让 ECDSA 终端证书被更广泛的采纳，和更小的证书体积。</p>
<p>鉴于我们每天要颁发 150 万张证书，这些证书有什么特别？为什么颁发它们？怎么颁发它们？让我们通过解释 CA 是如何思考和工作的来回答这些问题。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>每一个被公众信任的 CA (例如 Let’s Encrypt) 都至少有一个根证书被众多的浏览器和操作系统 (例如 Mozilla 和 Google) 的信任跟存储所包含。通过这种方式，用户可以确认他们从网站收到的证书是一个被浏览器信任的机构所颁发的。但是根证书由于它们的广泛传播以及较长的信赖周期，它的秘钥必须被妥善的保护并离线保管，以防止被用来不停地签发。因此 CA 会有若干个中间证书来替代根证书以确保证日常安全。</p>
<p>最近 5 年里， Let’s Encrypt 只有一个根证书： ISRG Rott X1，它拥有一个 4096 位的 RSA 秘钥并且有效期直到 2035 年。</p>
<p>也是在这段时间里，我们有了四个中间证书，分别是 Let’s Encrypt Authorities X1, X2, X3 和 X4。 前两个是 Let’s Encrypt 刚开始运营的 2015 年颁发的，有效期为 5 年；后两个是一年后，也就是 2016 年颁发的，有效期 5 年，并将在明年的这个时候过期。所有的这些中间证书都使用 2048 位的秘钥。此外，这些中间证书都由 IdenTrust 公司的 DST Root CA X3 根证书交叉签署，这个证书由另一家广泛被信任的 CA 所管理。</p>
<p>Let’s Encrypt 到 2020 年 8 月的结构图</p>
<p><img src="/images/2020/letsencrypt-aug-2020.png" alt="8月"></p>
<h2 id="新证书"><a href="#新证书" class="headerlink" title="新证书"></a>新证书</h2><p>首先，我们颁发了两个 2048 位秘钥的 RSA 中间证书：R3 和 R4. 这两个证书都由 ISRG Root X1 签署，拥有 5 年的有效期。同样交由 IdentTrust 交叉签署。它们实际上是 X3 和 X4 的直接替代，考虑到它们一年后即将到期。我们预计会在今年底把主要的证书颁发流水线切换到使用 R3 证书，不会对证书的颁发和续签的造成实际的影响。</p>
<p>另一个新证书更有意思一点。首先，我们有了一个新的 ISRG Root X2，将会使用 ECDSA P-384 替代 RSA，有效期到 2040 年。由它颁发了两个新的中间证书：E1 和 E2，签名算法也是 ECDSA 并且有效期为 5 年。</p>
<p>值得注意的是，这些新中间证书并没交由 IdentTrust 的 DST Root CA X3 交叉签署, ISRG Root X2 本身由 ISRG Root X1 交叉签署。敏锐的观察者可能也会注意到我们没有通过  ISRG Root X2 颁发有 OCSP 签名的证书。</p>
<p>Let’s Encrypt 到 2020 年 9 月的结构图</p>
<p><img src="/images/2020/letsencrypt-sept-2020.png" alt="9月"></p>
<p>既然已经讨论到了技术细节，不妨再深入了解下这个结构的由来。</p>
<h2 id="为什么颁发-ECDSA-的根证书和中间证书"><a href="#为什么颁发-ECDSA-的根证书和中间证书" class="headerlink" title="为什么颁发 ECDSA 的根证书和中间证书"></a>为什么颁发 ECDSA 的根证书和中间证书</h2><p>已经有好多文章讨论过 ECDSA 的好处 (相同加密程度下更小的秘钥，更快的加密，解密，签名，验证等操作)。不过对我们来说，更大的好处来自于证书体积的缩小。</p>
<p>每一个通过 <code>https://</code> 到远程主机的链接都需要一次 TLS 握手。每一个 TLS 握手都需要服务器提供它的证书。校验证书的过程还包括检查证书链（包括直到可信根证书的所有中间证书），这通常也是由有服务器提供的。这就意味这每个链接，一个覆盖各种广告和跟踪像素的页面会包含几十甚至上百个链接，这会需要传输大量的证书数据。并且每个证书都包含自己的公钥和签发者的签名。</p>
<p>一个 2048 位的 RSA 公钥大概 256 字节，而一个 ECDSA P-284 的公钥只有 48 字节。类似的， RSA 的签名会需要额外的 256 字节，而 ECDSA 只需要 96 字节。再考虑到其他一些开销，每个证书能节约大约 400 字节。用这个数乘以你的证书链长度以及每天的链接数，带宽的节省就很可观了。</p>
<p>这些省下的流量不仅会使我们的证书使用者每月节省大量的带宽费用，也惠及那些有限的、受限的终端用户。提高整个互联网的隐私性不仅是采用证书技术，也包括这让这些技术更经济。</p>
<p>此外由于我们很关心证书的大小，我们还采取了一些其它手段来让证书变得更小。我们把证书的主体名字由 “Let’s Encrypt Authority X3” 缩减到 “R3”，这是给予机构名称里已经提供了冗余的 “Let’s Encrypt”。同时我们还缩短了 Authority Information Access Issuer 和 CRL Distribution Point 的 URL 长度，我们还整个砍掉了 CPS 和 OCSP 的 URL。通过这些手段我们能够在不丢失实质性信息的情况下让证书再缩小 120 字节。</p>
<h2 id="为什么交叉签署-ECDSA-根证书"><a href="#为什么交叉签署-ECDSA-根证书" class="headerlink" title="为什么交叉签署 ECDSA 根证书"></a>为什么交叉签署 ECDSA 根证书</h2><p>交叉签署是新根证书从被签发到被主流信任的过渡阶段很重要的步骤。我们知道 ISRG Root X2 可能需要 5 年甚至更长时间才能被广泛接受，所以 E1 中间证书签发的证书如果希望被信任，一定需要证书链中某处的交叉签署。</p>
<p>我们基本上有两种方法：用现有的 ISRG Root X1 交叉签署 ISRG Root X2，或者用 ISRG Root X1 直接交叉签署 E1 和 E2。接下来我们就来分析下这两种做法分别有什么优缺点。</p>
<p>交叉签署 ISRG Root X2 意味着如果一个用户在信任库里有 ISRG Root X2，那么该证书链就是 100% ECDSA ，可以利用前文所述的快速校验。并且在接下来的几年里随着 ISRG Root X2 被加到越来越多的信任库里，ECDSA 终端证书的验证会越来越快而不需要用户或者网站做什么。这么做的代价是，只要 X2 还不在信任库里，用户的客户端就需要验证两个中间证书包括 E1 和 X2 直到 X1 根证书。这显然增加了证书验证的时间。</p>
<p>直接交叉新签署中间证书也有问题。一方面所有证书链的长度是相同的，在证书使用者和被广泛信任的 ISRG Root X1 之间只有一个中间证书。但是另一方面，随着 ISRG Root X2 获得越来越广泛的的信任，我们需要通过切换到另外一个链来<br>保证所有都能享受全链 ECDSA 的好处。</p>
<p>最终我们认为全链 ECDSA 更重要，所以我们选择了第一个方案，交叉签署 ISRG Root X2 证书。</p>
<h2 id="为什么我们不提供-OCSP-Responder-了"><a href="#为什么我们不提供-OCSP-Responder-了" class="headerlink" title="为什么我们不提供 OCSP Responder 了"></a>为什么我们不提供 OCSP Responder 了</h2><p>OCSP 协议是用户客户端用来发现并实时检查证书是否被吊销的一种方式。无论何时，一个浏览器如果想要知道证书是否有效，它可以通过访问证书里的一个 URL 就能得到是或否的答案，这个结果是由另一个可以被用相同方式检查的证书签名。这对终端用户的证书来说是非常棒的，应为请求响应体积很小并且速度很快。根据访问的站点不同，任何一个用户可能会关心（因此必须下载）海量证书集合的有效性。</p>
<p>但是中间证书只是海量证书的一个小小的子集，并且通常是广为人知的，也很少被吊销。因此，提供一个所有常用中间证书的吊销列表可能会更有效。我们的中间证书都包括一个 URL，通过这个 URL 浏览器可以下载证书的 CRl。实际上有些浏览器甚至会在例行更新里带上 CRL 列表集合，这使得在检查中间证书有效性的时候不需要再进行一次额外的访问开销，从而为大家创造更好的体验。</p>
<p>实际上用来指导 CA 的 Baseline Requirements 最近一次更新表明，中间证书已经不再强制要求包含一个 OCSP URL，而是可以只通过 CRL 来发布自己的吊销信息。鉴于此，我们从中间证书里移除了 OCSP URL，即我们不再需要为所有 ISRG Root X2 颁发的中间证书提供 OCSP Responder。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此我们已经介绍了新证书，最后再提一点：我们是怎么颁发这些证书的。</p>
<p>创建新根证书和中间证书是一个大事件，因为它们是被监管的的并且需要极其小心地看管好秘钥。这个事件是如此重要以至于颁发新证书被称作是“仪式”。在 Let’s Encrypt 我们非常推崇机器自动化，所以我们想要这个仪式的人为干预越少越好。</p>
<p>在过去的几个月里我们为这个仪式建立了一个工具，如果输入正确的配置，就能够生成所需的秘钥、证书和交叉签名请求等。我们还建立了一个仪式的 Demo 来说明这个配置文件可以并且允许所有人来运行和检查结果。我们的 SRE 搭建了一个相同并配有硬件安全模块的网络，自己执行了若干次仪式以确保整个流程完美无暇。我们与技术委员会、社区和若干邮件列表分享了这个 Demo，在这个过程中获得了很多有价值的反馈，其中一些甚至影响了上面我们提到的一些决定。最终、在 2020 年 9 月 3 号，我们的执行董事和 SRE 在一个安全的数据中心碰面并执行了整个仪式，并且有录像以供审计用。</p>
<p>现在仪式已经完成。我们已经更新了证书页面上关于新证书的细节，并且开始着手于申请将我们的新根证书加入到若干个信任库中。我们会在未来几周里开始用新中间证书来签发证书，并在社区论坛里发布进一步的公告。</p>
<p>希望我们关于新证书结构的导览是有趣的和干货的。我们期待继续通过一张张的证书来改进互联网隐私。我们由衷感谢 IdenTrust 在早期和后来不间断的支持我们让互联网更安全的愿景。</p>
<p>我们依靠社区和支持者来提供我们的服务。如果你的公司或者机构希望可以赞助 Let’s Encrypt 可以发邮件到 sponsor#letsencrypt.org 。我们需要您力所能及的帮助、</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2020/09/18/letsencrypt-root-ca.html" data-id="cm0177mo9000v3kq6fvn2dxzf" data-title="[译] Let&#39;s Encrypt 的新根证书和中间证书" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pki/" rel="tag">pki</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%94%E8%AE%B2/">演讲</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%83%B3/">随想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/alpine/" rel="tag">alpine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/" rel="tag">devops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/" rel="tag">istio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opensource/" rel="tag">opensource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pki/" rel="tag">pki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pycharm/" rel="tag">pycharm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vagrant/" rel="tag">vagrant</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/alpine/" style="font-size: 10px;">alpine</a> <a href="/tags/devops/" style="font-size: 20px;">devops</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/istio/" style="font-size: 10px;">istio</a> <a href="/tags/opensource/" style="font-size: 10px;">opensource</a> <a href="/tags/pki/" style="font-size: 10px;">pki</a> <a href="/tags/pycharm/" style="font-size: 10px;">pycharm</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vagrant/" style="font-size: 10px;">vagrant</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/05/01/my-first-commit-to-alpine.html">我的第一个 Alpine OS Commit</a>
          </li>
        
          <li>
            <a href="/2023/12/27/new-baby.html">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
          </li>
        
          <li>
            <a href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
          </li>
        
          <li>
            <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html">为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" />
</a></br>
All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></br>
      
      &copy; 2024 longtian<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>