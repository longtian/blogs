<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58200086-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58200086-6');
</script>
<!-- End Google Analytics -->

  
  <title>龙天的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="龙天的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="龙天的博客">
<meta property="og:url" content="https://blog.longtian.io/index.html">
<meta property="og:site_name" content="龙天的博客">
<meta property="og:description" content="龙天的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="longtian">
<meta property="article:tag" content="技术博客">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="龙天的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">龙天的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">大前端，DevOps，敏捷开发</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.longtian.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-rtos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/06/rtos.html" class="article-date">
  <time class="dt-published" datetime="2024-11-06T15:55:39.000Z" itemprop="datePublished">2024-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/11/06/rtos.html">[译] 等了 20 年，实时 Linux 终于进入了主线</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://www.zdnet.com/article/20-years-later-real-time-linux-makes-it-to-the-kernel-really/">原文</a></p>
<p>实时 Linux 相关的工作已经让开源操作系统受益了好多年，但直到这周 Linus Torvalds 才终于接受它的最后一部分进入主线内核。为什么会花这么久呢？</p>
<p>作者： Steven Vaughan-Nichols 资深特约编辑</p>
<p>2024 年 9 月 18 号</p>
<p>维也纳 – 实时 Linux （<code>PREEMPT_RT</code>） 终于在 20 年后进入了主线内核。Linus Torvalds 在欧洲开源峰会上为这份代码祈福。为什么这是个大事件？让我们首先介绍一下实时操作系统（RTOS）和它适用场景。</p>
<h1 id="什么是-RTOS-？"><a href="#什么是-RTOS-？" class="headerlink" title="什么是 RTOS ？"></a>什么是 RTOS ？</h1><p>RTOS 是一种专门的操作系统，旨在精准和可靠地处理时间关键任务。与 Windows 或者 MacOS 这类通用操作系统不同，RTOS 建立之初是为了在严格的时间限制下响应事件和处理数据，通常是以毫秒或微秒为单位。正如著名的实时 Linux 开发者、谷歌员工 Steven Rostedet 所说：“实时是最快的最坏场景。” </p>
<p>他的意思是 RTOS 最基本的特征是确定性行为。RTOS 能够保证关键任务在指定期限内完成。很多人认为 RTOS 就是为了快速处理。其实不然，速度不是 RTOS 的关键，可靠性才是。这种可预测性在时间关键应用中尤为重要，例如工业控制系统，医疗设备和航空航天器材。</p>
<p>当今一个正被使用的 RTOS 例子是 VxWorks，它在 NASA 火星探测器上被用来导航，并在波音 787 梦想号客机上用作飞行控制系统，确保飞行控制的实时响应。另一个例子是 QNX Neutrino，它被广泛应用与车载信息娱乐系统和高级辅助驾驶系统中，比如防抱死刹车系统。</p>
<h1 id="实时-Linux-的历史"><a href="#实时-Linux-的历史" class="headerlink" title="实时 Linux 的历史"></a>实时 Linux 的历史</h1><p>实时 Linux 的代码现在已经通过即将发布的 Linux 6.12 内核被纳入到了所有的 Linux 发行版中。这意味着 Linux 很快会出现在更多的关键任务设备和工业硬件上。 这着实花了不少时间。</p>
<p>实时 Linux 起源于 1990 年代对实时应用的不断增长的需求。早期工作主要致力于在 Linux 内核之外创建一个单独的内核。它包括若干个学术项目，比如堪萨斯大学的 KURT 项目，米兰大学的 RTAI 项目和新墨西哥矿业理工学院的 RTLinux。</p>
<p>到 2004 年，Ingo Molnar，一个资深的 Linux 内核开发者开始收集和重塑这些技术碎片，并奠定了实时抢占补丁集 <code>PREEMPT_RT</code> 的基础。</p>
<p>这个方法和早期的实时 Linux 的方案不同，因为它修改了已有的 Linux 内核而不是创建另外一个单独的实时内核。到 2006 年，它已经获得了足够的关注，以至于 Linus  Torvalds 说 “用 Linux 控制一束激光很疯狂，但这个屋子每个人都或多或少有一些疯狂。所以如果你想用 Linux 来控制工业焊接激光器，我对你使用 PREEPT_RT 没意见”</p>
<p>到 2009 年，一个包含了 Thomas Gleixner, Peter Ziljstra 和 Rostedt 的内核开发者小队，已经把之前的若干原型开发整合成了一个单独的树外补丁集。也就是从这个时候开始，很多公司开始使用这个补丁集来创建需要精确到毫秒的硬实时工业系统。</p>
<p>随着项目推进，它的很多组件已经进入了内核。 Rostedt 告诉我，说实时现在才进入 Linux 在某种程度上是错误的。它的很多功能已经进入了主线 Linux 很多年。有些对于你日常使用的 Linux 已经是必不可少。</p>
<p>比如，你可能从来没听说过 “NO_HZ” ，它能够减少系统在空闲状态下的功耗。“NO_HZ” 使得 Linux 能够在有几千个 CPU 的机器上高效运行。“你感受不到实时补丁给 Linux 带来了多大的改进” Rostedt 强调说 “我们的工作是 Linux 能够在数据中心里运行的唯一原因”</p>
<p>因此，如果没有 “NO_HZ”，Linux 就基本上不能在所有数据中运行。这也反过来解释了为什么 Linux 能在云上运行。我不知道没有这个实时补丁的贡献世界将会怎么样，但是它一定不像今天这样。</p>
<p>起初，谁做梦都不会想到实时 Linux 被证明有用的方式。 Rostedt 回忆道 “早在 2005 年的时候，我收到一个关于实时的错误报告，我回复：‘嘿这是修复的代码，你能应用它吗？’那个家伙说‘我不知道我在做什么’，我回复：‘等等你不是一个内核开发者吗？’他答道：‘我是一个吉他手’” </p>
<p>原来，他之所以会用到早期的实时性补丁是因为他在用一个叫做 JACK 的系统，这是一个低延迟音频链接的声音服务器。他和大多数音乐人一样，穷到没有钱买高级的设备，Rostedt 继续说道 “他搞到一台便宜的笔记本，上面装着 Linux 和 JACK，正因为实时性补丁，它能够录到很好的音频，没有由于硬盘写导致的声音跳跃”</p>
<p>结果就是很多音乐家都是实时 Linux 的早期用户，因为这让他们能够在便宜的设备上录制高质量的唱片。这谁会知道？近几年，其它悄然进入内核的实时特性还包括</p>
<ul>
<li>互斥锁的引入</li>
<li>Ftrace，可以说是最重要的 Linux 调试工具</li>
<li>用户空间应用程序的优先级继承</li>
</ul>
<h1 id="实时-Linux-怎么用了这么长时间？"><a href="#实时-Linux-怎么用了这么长时间？" class="headerlink" title="实时 Linux 怎么用了这么长时间？"></a>实时 Linux 怎么用了这么长时间？</h1><p>那么为什么实时 Linux 直到现在才进入内核呢？“实际上我们不会推上去任何东西，除非我们觉得准备好了” Rostedt 解释到 “几乎所有的代码都会被重写三次以上才会进入到主干，因为我们的准入门槛非常高”</p>
<p>此外，通往主线之路并不只是一个技术挑战。政治和观念也起了很重要的作用，“开始的时候我们甚至不能提实时” Rostedt 回忆道，每个人都会说 “哦，我们不在乎实时”</p>
<p>另外一个问题是资金。实时 Linux 开发经费在好几年里飘忽不定。在 2015 年， Linux 基金会成立了实时 Linux （RTL） 的合作项目，来协调围绕主线 <code>PREEMPT_RT</code> 的维护工作。</p>
<p>全面集成前最后一个关卡是内核 <code>print_k</code> 函数的重构，这是一个可以追溯到 1991 年的重要调试工具。Torvalds 对 <code>print_k</code> 有很强的保护欲，他写的原始的代码并且一直用到今天。然而，每当 <code>print_k</code> 在被调用的时候也导致了 Linux 程序产生严重的延迟。这种延迟在实时系统里是无法接受的。</p>
<p>Rostedt 解释说：“<code>print_k</code> 为了处理上千种不同的场景有上千个 Hack。每当我们想要修改 <code>print_k</code> 做些什么的时候，它就会破坏其中某个场景。<code>print_k</code> 实际上是非常棒的调试工具，他能让你准确知道一个进程在哪里挂掉了。当我非常努力想要锻造系统的时候，延迟总是在 30 毫秒左右，然后突然的延迟就降到了 5 微秒” 这个延迟就是 <code>print_k</code> 消息。</p>
<p>经过大量工作，多次激烈讨论和若干被毙掉的提案后，今年早些时候终于达成了折中方案。这下 Torvalds 高兴了，实时 Linux 开发者高兴了，<code>print_k</code> 用户也高兴了，到此实时 Linux 才终成真。</p>
<p>经历了 20 年的不懈努力，Linux 实时补丁终被纳入主线内核。这一里程碑标志着内核开发者将确定性、低延迟性能带进了 Linux 的多年的努力达到了顶峰。</p>
<p>有了它，Linux 内核才可以完全抢占，从而能在微秒之间相应事件。这个能力对于要求精确计时的如工业控制系统、机器人和音频制作的应用来所是非常关键的。</p>
<p>随着实时性补丁的合并， Linux 现在已经成为 RTOS 世界一个重要玩家。这不只是实时开发者的胜利更是所有 Linux 用户的胜利。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2024/11/06/rtos.html" data-id="cm4a44ui5001sooq6etst2blq" data-title="[译] 等了 20 年，实时 Linux 终于进入了主线" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-my-first-commit-to-alpine" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/01/my-first-commit-to-alpine.html" class="article-date">
  <time class="dt-published" datetime="2024-04-30T16:00:00.000Z" itemprop="datePublished">2024-05-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/01/my-first-commit-to-alpine.html">我的第一个 Alpine OS Commit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近特别爱用 Alpine OS， 试着在上面使用 K3S 搭建一个 Kubernetes 集群。</p>
<p>当时使用的版本是 <code>Alpine v3.19</code> ，包管理器里自带的 Kubernetes 版本是 <code>k3s-1.28.8.1-r1</code>，安装过程没有报错，但是启动的时候有一个 <code>Fatal Error</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time=<span class="string">&quot;2024-04-10T00:58:17+08:00&quot;</span> level=fatal msg=<span class="string">&quot;Failed to validate golang version: kubernetes golang build version not set - see &#x27;golang: upstream version&#x27; in https://github.com/kubernetes/kubernetes/blob/v1.28.8/build/dependencies.yaml&quot;</span></span><br></pre></td></tr></table></figure>

<p>之后定位到是 Alpine OS 包管理器没有及时同步上游的改动的问题，看到有人已经在 <code>Edge</code> 频道里修复了 <a target="_blank" rel="noopener" href="https://gitlab.alpinelinux.org/alpine/aports/-/issues/15748">#15748</a>，我就基于这个改动，在 <code>Community</code> 频道里也修复了 <a target="_blank" rel="noopener" href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/63824">#63824</a></p>
        
          <p class="article-more-link">
            <a href="/2024/05/01/my-first-commit-to-alpine.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2024/05/01/my-first-commit-to-alpine.html" data-id="cm4a44uhx0016ooq6b98phr9z" data-title="我的第一个 Alpine OS Commit" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/alpine/" rel="tag">alpine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/devops/" rel="tag">devops</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-new-baby" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/27/new-baby.html" class="article-date">
  <time class="dt-published" datetime="2023-12-27T03:00:00.000Z" itemprop="datePublished">2023-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>几天绝对是一个值得纪念的日子 :)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Baby</span>()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2023/12/27/new-baby.html" data-id="cm4a44uhy0017ooq6ea0n109l" data-title="" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-reading-2022" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/21/reading-2022.html" class="article-date">
  <time class="dt-published" datetime="2022-06-21T03:23:16.000Z" itemprop="datePublished">2022-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今年上半年突然多了很多时间看书，先把以前囤的纸质书翻了翻，后来又买了一个华为出品的墨水屏，立刻荣升阅读主力。<br>总的来说搭配微信阅读 App 的付费会员还是比较省钱的，预计今年底就能回本。</p>
        
          <p class="article-more-link">
            <a href="/2022/06/21/reading-2022.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/06/21/reading-2022.html" data-id="cm4a44ui4001pooq685vl2xd9" data-title="我的 2022 书单" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-how-gps-work" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/11/how-gps-work.html" class="article-date">
  <time class="dt-published" datetime="2022-02-11T10:09:40.000Z" itemprop="datePublished">2022-02-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前订阅了 ciechanowski 大神的博客，虽然更新不频繁（一年几篇）但是每一篇都属于精品。大神总是能结合前端可视化技术把一些天文、物理什么的知识点讲解的很透彻。</p>
<p><a target="_blank" rel="noopener" href="https://ciechanow.ski/gps/">GPS</a> 这篇文章刚发布没几天我就注意到了，赶紧拜读了一下。从三角定位讲到相对论再到卫星信号的编解码，内容非常详实，交互动画的制作精美无比可以说是教案水准。</p>
<p>因为某些原因，2022 这个春节能够在家待上好长一阵子。所以我就利用这个机会前后花了大概 10 天时间把这篇文章翻译成了 <a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">中文版</a>，希望能够对所有对 GPS 工作原理感兴趣的朋友带来帮助。</p>
<h3 id="文章地址"><a href="#文章地址" class="headerlink" title="文章地址"></a>文章地址</h3><p><a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">pages.longtian.info&#x2F;gps</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/02/11/how-gps-work.html" data-id="cm4a44uhr000fooq6bztbd0k6" data-title="[译] GPS 工作原理的可视化" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-different-image-digest-in-console-and-on-hub" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html" class="article-date">
  <time class="dt-published" datetime="2021-11-25T03:48:29.000Z" itemprop="datePublished">2021-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/25/different-image-digest-in-console-and-on-hub.html">为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个问题困扰自己很久了，今天终于搞明白了。</p>
<p>复现： 在 Docker Hub 查看 alpine 的镜像信息，并在主机上执行 <code>docker pull alpine:3.12</code><br>问题： 在网站上看到的 <code>Digest</code> 和控制台里显示的 <code>Digest</code> 不一样</p>
<p>控制台显示的 <code>Digest</code> 是 <code>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3.12: Pulling from library/alpine</span><br><span class="line">Digest: sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</span><br><span class="line">Status: Image is up to <span class="built_in">date</span> <span class="keyword">for</span> alpine:3.12</span><br><span class="line">docker.io/library/alpine:3.12</span><br></pre></td></tr></table></figure>

<p>这个 <code>Digest</code> 并不在 alpine:3.12 官方仓库对应不同平台的<a target="_blank" rel="noopener" href="https://hub.docker.com/_/alpine?tab=tags&page=1&name=3.12">镜像列表</a> 里</p>
<table>
<thead>
<tr>
<th>DIGEST</th>
<th>OS&#x2F;ARCH</th>
<th>COMPRESSED SIZE</th>
</tr>
</thead>
<tbody><tr>
<td>7893969ec350</td>
<td>linux&#x2F;386</td>
<td>2.67 MB</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://hub.docker.com/layers/alpine/library/alpine/3.12/images/sha256-74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18">74e5ad84a67e</a></td>
<td>linux&#x2F;amd64</td>
<td>2.68 MB</td>
</tr>
<tr>
<td>8a6e4b2093ee</td>
<td>linux&#x2F;arm&#x2F;v6</td>
<td>2.49 MB</td>
</tr>
<tr>
<td>45a18fc6f681</td>
<td>linux&#x2F;arm&#x2F;v7</td>
<td>2.31 MB</td>
</tr>
<tr>
<td>29ba524fa7f5</td>
<td>linux&#x2F;arm64&#x2F;v8</td>
<td>2.59 MB</td>
</tr>
<tr>
<td>08340ab4a605</td>
<td>linux&#x2F;ppc64le</td>
<td>2.69 MB</td>
</tr>
<tr>
<td>9a7276e7579f</td>
<td>linux&#x2F;s390x</td>
<td>2.46 MB</td>
</tr>
</tbody></table>
<p>那么这两个 <code>Digest</code>，到底以那个为准呢</p>
<ul>
<li>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</li>
<li>74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/11/25/different-image-digest-in-console-and-on-hub.html" data-id="cm4a44uhp0009ooq6cwqf1cjl" data-title="为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-kubernetes-resources" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/12/kubernetes-resources.html" class="article-date">
  <time class="dt-published" datetime="2021-07-12T03:27:21.000Z" itemprop="datePublished">2021-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/12/kubernetes-resources.html">Kubernetes 资源分配</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近遇到了 Kubernetes 上的 Web 应用响应时间长尾的问题，上网收集资料，分析了一下原因。</p>
<ul>
<li>CGroup 节流导致 Web 请求相应时间增加</li>
<li>当前执行的 CPU 不断变动</li>
<li>核数越多 CGroup 补偿碎片越严重</li>
<li>跨越 NUMA 节点</li>
</ul>
<h2 id="请求和限制计算资源"><a href="#请求和限制计算资源" class="headerlink" title="请求和限制计算资源"></a>请求和限制计算资源</h2><p>Kubernetes 对资源的细粒度管理功能可以说是吸引传统应用上 Kubernetes 的重要原因之一</p>
<p>我们在定义 Pod 的时候通过以下两个字段可以控制计算资源的分配：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests</code></td>
<td>请求的最少资源</td>
</tr>
<tr>
<td><code>limits</code></td>
<td>资源限制</td>
</tr>
</tbody></table>
<ul>
<li>当 <code>requests</code> 无法满足时，<code>Pod</code> 会一直停在 <code>Pending</code> 状态，触发 <code>FailedScheduling</code> 事件</li>
<li>当使用内存资源超过 <code>limits</code> 时，如果有其他 POD 需要内存，则使用内存最多的容器会被 <code>sacrifice</code>，触发 <code>OOMKilled</code> 事件</li>
<li>如果不指定 <code>limits</code> , 在没有命名空间默认值的情况下可以无限制地使用资源</li>
<li>如果指定了 <code>limits</code> , 但是没有指定 <code>requests</code> , 则 <code>requests</code> 值默认为 <code>limits</code> 值</li>
<li>从分配角度讲 <code>CPU</code> 属于可以压缩的资源、内存属于不可以压缩的资源</li>
</ul>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mem-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;150M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="命名空间默认值、最小值和最大值"><a href="#命名空间默认值、最小值和最大值" class="headerlink" title="命名空间默认值、最小值和最大值"></a>命名空间默认值、最小值和最大值</h2><p>有些 Kubernetes 集群环境下会出现这样的问题：定义 Pod 的时候明明没有给计算资源的限制，但是在实际运行的 Pod 上出现了资源限制的定义。</p>
<p>这很有可能是命名空间的默认值造成的。 通过 <code>LimitRange</code> 对象可以设置命名空间资源的默认值、最小值和最大值。</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>default</td>
<td><code>limit</code></td>
</tr>
<tr>
<td>defaultRequest</td>
<td><code>request</code></td>
</tr>
<tr>
<td>min</td>
<td>最小值</td>
</tr>
<tr>
<td>max</td>
<td>最大值</td>
</tr>
<tr>
<td>maxLimitRequestRatio</td>
<td>比率</td>
</tr>
<tr>
<td>type</td>
<td>对象</td>
</tr>
</tbody></table>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">mem-min-max-demo-lr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod-服务质量"><a href="#Pod-服务质量" class="headerlink" title="Pod 服务质量"></a>Pod 服务质量</h2><p>当系统资源不足时就会有 Pod 遭殃，但是那么多 Pod 怎么知道要干掉哪一个呢。这就和 Pod 的服务质量有关。</p>
<p>查看运行中的 <code>Pod</code> 会有一个 <code>qosClass</code> 字段，它有以下三种取值：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Guaranteed</td>
<td>被保证的，优先级最高，除非超过限制不然不会被干掉</td>
</tr>
<tr>
<td>Burstable</td>
<td>允许突发，位于中间, 当系统资源不足且没有 <code>Best-Effort</code> 级别时</td>
</tr>
<tr>
<td>BestEffort</td>
<td>尽力保证，优先级最低，当系统资源不足时最先被干掉</td>
</tr>
</tbody></table>
<p>需要注意 <code>qosClass</code> 的值无法直接设置，而是通过 <code>requests</code> 和 <code>limits</code> 组合隐式设置</p>
<h3 id="Guaranteed"><a href="#Guaranteed" class="headerlink" title="Guaranteed"></a>Guaranteed</h3><ul>
<li>Pod 中的每个容器都要指定 CPU 请求和限制，并且两者相等</li>
<li>Pod 中的每个容器都要指定内存请求和限制，并且两者相等</li>
</ul>
<h3 id="Burstable"><a href="#Burstable" class="headerlink" title="Burstable"></a>Burstable</h3><ul>
<li>Pod 不符合 Guaranteed QoS 类的标准</li>
<li>Pod 至少有一个容器具有 CPU 或内存请求</li>
</ul>
<h3 id="BestEffort"><a href="#BestEffort" class="headerlink" title="BestEffort"></a>BestEffort</h3><ul>
<li>没有 CPU、内存请求和限制</li>
</ul>
<h2 id="CPU-管理策略"><a href="#CPU-管理策略" class="headerlink" title="CPU 管理策略"></a>CPU 管理策略</h2><p>在现代操作系统的设计下，负载运行可能会不断地迁移到不同的 CPU 核心，Kubernetes 上也是一样。</p>
<p>Kubernetes 提供了 CPU 管理策略来实现负载和 CPU 核的绑定。</p>
<p>通过 kubelet 参数 <code>--cpu-manager-policy</code> 来指定 CPU 管理策略。</p>
<table>
<thead>
<tr>
<th>取值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>none</td>
<td>默认策略，按照 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E5%85%AC%E5%B9%B3%E6%8E%92%E7%A8%8B%E5%99%A8">CFS</a> 来执行调度</td>
</tr>
<tr>
<td>static</td>
<td>允许为节点上具有某些资源特征的 Pod 赋予增强的 CPU 亲和性和独占性</td>
</tr>
</tbody></table>
<p>为了将 Pod 绑定到 CPU 需要</p>
<ul>
<li>Kubelet 开启 <code>--cpu-manager-policy static</code></li>
<li>Pod 的服务优先级为 <code>Guaranteed</code></li>
<li>Pod 的 CPU 资源为整数</li>
</ul>
<p>例如，下面的 Nginx Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br></pre></td></tr></table></figure>

<p>在运行时可独占两颗 CPU</p>
<h2 id="NUMA-和拓扑管理策略"><a href="#NUMA-和拓扑管理策略" class="headerlink" title="NUMA 和拓扑管理策略"></a>NUMA 和拓扑管理策略</h2><p>NUMA 是系统优化的一个常用思路，它是伴随着多处理器出现的一个问题。</p>
<blockquote>
<p>非统一内存访问架构（英语：Non-uniform memory access，简称NUMA）是一种为多处理器的电脑设计的内存架构，内存访问时间取决于内存相对于处理器的位置。</p>
</blockquote>
<p>常见的硬件有</p>
<ul>
<li>CPU</li>
<li>Memory</li>
<li>GPU</li>
<li>NIC</li>
</ul>
<p>安装 <code>numactl</code> 后可以通过下面的命令查看主机的 NUMA 相关信息</p>
<p><code>numactl --harware</code></p>
<p>通过下面的命令查看 NUMA 的统计信息</p>
<p><code>numastat</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">numa_hit       | Number of pages allocated from the node the process wanted.</span><br><span class="line">numa_miss      | Number of pages allocated from this node, but the process preferred another node.</span><br><span class="line">numa_foreign   | Number of pages allocated another node, but the process preferred this node.</span><br><span class="line">local_node     | Number of pages allocated from this node while the process was running locally.</span><br><span class="line">other_node     | Number of pages allocated from this node while the process was running remotely (on another node).</span><br><span class="line">interleave_hit | Number of pages allocated successfully with the interleave strategy.</span><br></pre></td></tr></table></figure>

<p>以上指标均可以通过 Telegraf 监控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.kernel_vmstat]]</span><br></pre></td></tr></table></figure>

<p><code>--cpu-manager-policy static --topology-manager-scope pod --topology-manager-policy single-numa-node</code></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/">https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/">https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/">https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/07/12/kubernetes-resources.html" data-id="cm4a44uhu000tooq64xje7aat" data-title="Kubernetes 资源分配" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-istio-response-flags" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/21/istio-response-flags.html" class="article-date">
  <time class="dt-published" datetime="2021-04-21T07:40:35.000Z" itemprop="datePublished">2021-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/21/istio-response-flags.html">Istio 请求响应标志</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>整理了一下 Istio 的 Response Flags</p>
<p><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-response-flags">介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy/blob/v1.18.2/source/common/stream_info/utility.h#L21">源码</a></p>
<table>
<thead>
<tr>
<th>协议</th>
<th>缩写</th>
<th>备注</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP</td>
<td>DC</td>
<td>DOWNSTREAM_CONNECTION_TERMINATION</td>
<td>Downstream connection termination.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DI</td>
<td>DELAY_INJECTED</td>
<td>The request processing was delayed for a period specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DPE</td>
<td>DOWNSTREAM_PROTOCOL_ERROR</td>
<td>The downstream request had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>FI</td>
<td>FAULT_INJECTED</td>
<td>The request was aborted with a response code specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>IH</td>
<td>INVALID_ENVOY_REQUEST_HEADERS</td>
<td>The request was rejected because it set an invalid value for a strictly-checked header in addition to 400 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LH</td>
<td>FAILED_LOCAL_HEALTH_CHECK</td>
<td>Local service failed health check request in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LR</td>
<td>LOCAL_RESET</td>
<td>Connection local reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NC</td>
<td>NO_CLUSTER_FOUND</td>
<td>Upstream cluster not found.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NR</td>
<td>NO_ROUTE_FOUND</td>
<td>No route configured for a given request in addition to 404 response code, or no matching filter chain for a downstream connection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RL</td>
<td>RATE_LIMITED</td>
<td>The request was ratelimited locally by the HTTP rate limit filter in addition to 429 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RLSE</td>
<td>RATELIMIT_SERVICE_ERROR</td>
<td>The request was rejected because there was an error in rate limit service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>SI</td>
<td>STREAM_IDLE_TIMEOUT</td>
<td>Stream idle timeout in addition to 408 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UAEX</td>
<td>UNAUTHORIZED_EXTERNAL_SERVICE</td>
<td>The request was denied by the external authorization service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UC</td>
<td>UPSTREAM_CONNECTION_TERMINATION</td>
<td>Upstream connection termination in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UF</td>
<td>UPSTREAM_CONNECTION_FAILURE</td>
<td>Upstream connection failure in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UH</td>
<td>NO_HEALTHY_UPSTREAM</td>
<td>No healthy upstream hosts in upstream cluster in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UMSDR</td>
<td>UPSTREAM_MAX_STREAM_DURATION_REACHED</td>
<td>The upstream request reached to max stream duration.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UO</td>
<td>UPSTREAM_OVERFLOW</td>
<td>Upstream overflow (circuit breaking) in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UPE</td>
<td>UPSTREAM_PROTOCOL_ERROR</td>
<td>The upstream response had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UR</td>
<td>UPSTREAM_REMOTE_RESET</td>
<td>Upstream remote reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>URX</td>
<td>UPSTREAM_RETRY_LIMIT_EXCEEDED</td>
<td>The request was rejected because the upstream retry limit (HTTP) or maximum connect attempts (TCP) was reached.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UT</td>
<td>UPSTREAM_REQUEST_TIMEOUT</td>
<td>Upstream request timeout in addition to 504 response code.</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/21/istio-response-flags.html" data-id="cm4a44uht000nooq6ec8y2k8f" data-title="Istio 请求响应标志" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/istio/" rel="tag">istio</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-containerized-jvm-parameters" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/13/containerized-jvm-parameters.html" class="article-date">
  <time class="dt-published" datetime="2021-04-13T09:23:31.000Z" itemprop="datePublished">2021-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/13/containerized-jvm-parameters.html">JVM 对容器化支持的参数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>阅读本文你需要了解</p>
<ul>
<li>JVM 的启动参数</li>
<li>容器的启动参数</li>
</ul>
<h3 id="JVM-启动参数"><a href="#JVM-启动参数" class="headerlink" title="JVM 启动参数"></a>JVM 启动参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>-Xms</code></td>
<td>MiniumHeapSize</td>
</tr>
<tr>
<td><code>-Xmx</code></td>
<td>MaxHeapSize</td>
</tr>
<tr>
<td><code>-Xss</code></td>
<td>StackSize</td>
</tr>
</tbody></table>
<p>在容器化之前一般由运维工程师根据部署环境机器的内存大小来调整，并写在启动脚本里</p>
<h3 id="容器启动参数"><a href="#容器启动参数" class="headerlink" title="容器启动参数"></a>容器启动参数</h3><p>在使用 k8s 编排容器的时候通常通过定义 resources 字段来限制容器使用的资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limit:</span></span><br><span class="line">     <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">     <span class="attr">memory:</span> <span class="string">1G</span></span><br></pre></td></tr></table></figure>

<p>为了方便验证，我们直接用本地 docker 来实验，docker run 命令的一些参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>–cpus</td>
<td>Number of CPUs</td>
</tr>
<tr>
<td>–cpu-period int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) period</td>
</tr>
<tr>
<td>–cpu-quota int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) quota</td>
</tr>
<tr>
<td>–cpu-rt-period int</td>
<td>Limit CPU real-time period in microseconds</td>
</tr>
<tr>
<td>–cpu-rt-runtime int</td>
<td>Limit CPU real-time runtime in microseconds</td>
</tr>
<tr>
<td>–cpu-shares int</td>
<td>CPU shares (relative weight)</td>
</tr>
<tr>
<td>–memory</td>
<td>Memory limit</td>
</tr>
</tbody></table>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>容器化的 JVM 程序会遇到这几个问题</p>
<ul>
<li>问题 1： 超过了容器的资源限制被 OOM 机制杀掉</li>
<li>问题 2： 在核数比较高的机器上 JVM 频繁 GC</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2021/04/13/containerized-jvm-parameters.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/13/containerized-jvm-parameters.html" data-id="cm4a44uhm0003ooq6d9ei6yyu" data-title="JVM 对容器化支持的参数" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tencentyun" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/18/tencentyun.html" class="article-date">
  <time class="dt-published" datetime="2021-03-18T05:28:28.000Z" itemprop="datePublished">2021-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="腾讯-Centos-软件源的使用"><a href="#腾讯-Centos-软件源的使用" class="headerlink" title="腾讯 Centos 软件源的使用"></a>腾讯 Centos 软件源的使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo</span><br><span class="line">sed -i &#x27;s/cloud\.tencent\.com/tencentyun\.com/1&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/03/18/tencentyun.html" data-id="cm4a44ui80028ooq6c8sxeyma" data-title="" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%94%E8%AE%B2/">演讲</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%83%B3/">随想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/alpine/" rel="tag">alpine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/" rel="tag">devops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/" rel="tag">istio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opensource/" rel="tag">opensource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pki/" rel="tag">pki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pycharm/" rel="tag">pycharm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vagrant/" rel="tag">vagrant</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/alpine/" style="font-size: 10px;">alpine</a> <a href="/tags/devops/" style="font-size: 20px;">devops</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/istio/" style="font-size: 10px;">istio</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/opensource/" style="font-size: 10px;">opensource</a> <a href="/tags/pki/" style="font-size: 10px;">pki</a> <a href="/tags/pycharm/" style="font-size: 10px;">pycharm</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vagrant/" style="font-size: 10px;">vagrant</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">十一月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/06/rtos.html">[译] 等了 20 年，实时 Linux 终于进入了主线</a>
          </li>
        
          <li>
            <a href="/2024/05/01/my-first-commit-to-alpine.html">我的第一个 Alpine OS Commit</a>
          </li>
        
          <li>
            <a href="/2023/12/27/new-baby.html">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
          </li>
        
          <li>
            <a href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" />
</a></br>
All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></br>
      
      &copy; 2024 longtian<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>