<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58200086-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58200086-6');
</script>
<!-- End Google Analytics -->

  
  <title>龙天的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="龙天的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="龙天的博客">
<meta property="og:url" content="https://blog.longtian.io/index.html">
<meta property="og:site_name" content="龙天的博客">
<meta property="og:description" content="龙天的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="longtian">
<meta property="article:tag" content="技术博客">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="龙天的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">龙天的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">大前端，DevOps，敏捷开发</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.longtian.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-reading-2022" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/21/reading-2022.html" class="article-date">
  <time class="dt-published" datetime="2022-06-21T03:23:16.000Z" itemprop="datePublished">2022-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今年上半年突然多了很多时间看书，先把以前囤的纸质书翻了翻，后来又买了一个华为出品的墨水屏，立刻荣升阅读主力。<br>总的来说搭配微信阅读 App 的付费会员还是比较省钱的，预计今年底就能回本。</p>
<p><strong>读完：</strong></p>
<h2 id="《原则2》"><a href="#《原则2》" class="headerlink" title="《原则2》"></a>《原则2》</h2><p>居家隔离 7 天的时候读完，大循环的概念可以说是非常实用的长期投资参考</p>
<h2 id="《一本书读懂从来没懂过的经济学》"><a href="#《一本书读懂从来没懂过的经济学》" class="headerlink" title="《一本书读懂从来没懂过的经济学》"></a>《一本书读懂从来没懂过的经济学》</h2><p>以前确实忽视了理财，导致薪资占收入的几乎 100%，现在渐渐能看懂财报了，也学着投资黄金和基金</p>
<h2 id="《隐秘战争》"><a href="#《隐秘战争》" class="headerlink" title="《隐秘战争》"></a>《隐秘战争》</h2><h2 id="《美国陷阱》"><a href="#《美国陷阱》" class="headerlink" title="《美国陷阱》"></a>《美国陷阱》</h2><p>长臂管辖太强大了，美国政府的压倒性制裁普通公司根本扛不住，国家才是坚强的后盾</p>
<p>看本书我还整理了一个 <a target="_blank" rel="noopener" href="https://github.com/longtian/justice-system">美国刑事司法制度流程图</a> 需要自取，233333</p>
<h2 id="《金融战争》"><a href="#《金融战争》" class="headerlink" title="《金融战争》"></a>《金融战争》</h2><p>书架上翻出来的一本已经泛黄的盗版书，里面的内容还是有点阴谋论的味道的</p>
<h2 id="《创新公司：皮克斯的启示》"><a href="#《创新公司：皮克斯的启示》" class="headerlink" title="《创新公司：皮克斯的启示》"></a>《创新公司：皮克斯的启示》</h2><p>给自媒体公司如何保持作品质量、避免创意枯竭带来很多启示</p>
<h2 id="《斯蒂夫·乔布斯传》"><a href="#《斯蒂夫·乔布斯传》" class="headerlink" title="《斯蒂夫·乔布斯传》"></a>《斯蒂夫·乔布斯传》</h2><p>RIP Jobs, 再次读已经是 10 年后了，很多东西都发生了变化，苹果也不再是原来的苹果<br>连 Apple Music 都可以在备受鄙夷的 Android 系统上使用了</p>
<h2 id="《创新者的窘境》"><a href="#《创新者的窘境》" class="headerlink" title="《创新者的窘境》"></a>《创新者的窘境》</h2><p>据说是乔布斯读了好多遍的书（另外一本是关于禅修的，无感），怎么发展延续性和破坏性创新，这可能就是苹果至今保持市值的秘密</p>
<h2 id="《乌合之众》"><a href="#《乌合之众》" class="headerlink" title="《乌合之众》"></a>《乌合之众》</h2><p>失智的人群</p>
<h2 id="《无厂模式》"><a href="#《无厂模式》" class="headerlink" title="《无厂模式》"></a>《无厂模式》</h2><p>通过这本书可以大概了解芯片的产业链，尤其是最新的以 TSMC 为代表的的 Fabless 模式</p>
<h2 id="《芯片先进封装》"><a href="#《芯片先进封装》" class="headerlink" title="《芯片先进封装》"></a>《芯片先进封装》</h2><p>稀有气体在芯片制造业中的应用</p>
<h2 id="《奇妙的化学元素》"><a href="#《奇妙的化学元素》" class="headerlink" title="《奇妙的化学元素》"></a>《奇妙的化学元素》</h2><p>复习高中化学知识了属于是</p>
<h2 id="《没有工作的世界》"><a href="#《没有工作的世界》" class="headerlink" title="《没有工作的世界》"></a>《没有工作的世界》</h2><h2 id="《人体简史》"><a href="#《人体简史》" class="headerlink" title="《人体简史》"></a>《人体简史》</h2><h2 id="《看懂芯片原来这么简单》"><a href="#《看懂芯片原来这么简单》" class="headerlink" title="《看懂芯片原来这么简单》"></a>《看懂芯片原来这么简单》</h2><h2 id="《汽车是怎样跑起来的》"><a href="#《汽车是怎样跑起来的》" class="headerlink" title="《汽车是怎样跑起来的》"></a>《汽车是怎样跑起来的》</h2><p>好像从来没有研究过汽车是怎么跑起来的</p>
<h2 id="《寄生虫星球》"><a href="#《寄生虫星球》" class="headerlink" title="《寄生虫星球》"></a>《寄生虫星球》</h2><p>寄生虫太可怕了！ 寄生虫和情绪的关系令人称奇。</p>
<h2 id="《看一眼你就会笑》"><a href="#《看一眼你就会笑》" class="headerlink" title="《看一眼你就会笑》"></a>《看一眼你就会笑》</h2><p>好笑是好笑，就是有的梗有点重复了</p>
<h2 id="《生活蒙太奇》"><a href="#《生活蒙太奇》" class="headerlink" title="《生活蒙太奇》"></a>《生活蒙太奇》</h2><p>画风很减压</p>
<h2 id="《从0到无穷》"><a href="#《从0到无穷》" class="headerlink" title="《从0到无穷》"></a>《从0到无穷》</h2><p>数学啊数学</p>
<h2 id="《挽救计划》"><a href="#《挽救计划》" class="headerlink" title="《挽救计划》"></a>《挽救计划》</h2><p>期待电影</p>
<h2 id="《月背征途》"><a href="#《月背征途》" class="headerlink" title="《月背征途》"></a>《月背征途》</h2><p>嫦娥和月兔怎么做敏捷迭代的</p>
<h2 id="《识别急症陷阱》"><a href="#《识别急症陷阱》" class="headerlink" title="《识别急症陷阱》"></a>《识别急症陷阱》</h2><h2 id="《癌症·真相》"><a href="#《癌症·真相》" class="headerlink" title="《癌症·真相》"></a>《癌症·真相》</h2><p>跨国治疗癌症指南</p>
<h2 id="《牛津通识读本：免疫系统》"><a href="#《牛津通识读本：免疫系统》" class="headerlink" title="《牛津通识读本：免疫系统》"></a>《牛津通识读本：免疫系统》</h2><h2 id="《牛津通识读本：细胞》"><a href="#《牛津通识读本：细胞》" class="headerlink" title="《牛津通识读本：细胞》"></a>《牛津通识读本：细胞》</h2><p>很担心身边的家人、朋友会得癌症，提前做一些知识储备</p>
<p><strong>在读：</strong></p>
<p>《沃兹传：与苹果一起疯狂》<br>《癌症传》<br>《国富论》<br>《美联储》<br>《微积分的力量》<br>《财报就像一本故事书》<br>《枪炮、病菌和钢铁》<br>《算力时代：一场新的产业革命》</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/06/21/reading-2022.html" data-id="cm014jhxf001lpsq610320nyh" data-title="我的 2022 书单" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-how-gps-work" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/11/how-gps-work.html" class="article-date">
  <time class="dt-published" datetime="2022-02-11T10:09:40.000Z" itemprop="datePublished">2022-02-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前订阅了 ciechanowski 大神的博客，虽然更新不频繁（一年几篇）但是每一篇都属于精品。大神总是能结合前端可视化技术把一些天文、物理什么的知识点讲解的很透彻。</p>
<p><a target="_blank" rel="noopener" href="https://ciechanow.ski/gps/">GPS</a> 这篇文章刚发布没几天我就注意到了，赶紧拜读了一下。从三角定位讲到相对论再到卫星信号的编解码，内容非常详实，交互动画的制作精美无比可以说是教案水准。</p>
<p>因为某些原因，2022 这个春节能够在家待上好长一阵子。所以我就利用这个机会前后花了大概 10 天时间把这篇文章翻译成了 <a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">中文版</a>，希望能够对所有对 GPS 工作原理感兴趣的朋友带来帮助。</p>
<h3 id="文章地址"><a href="#文章地址" class="headerlink" title="文章地址"></a>文章地址</h3><p><a target="_blank" rel="noopener" href="https://pages.longtian.info/gps/">pages.longtian.info&#x2F;gps</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2022/02/11/how-gps-work.html" data-id="cm014jhx2000gpsq62jp2hghy" data-title="[译] GPS 工作原理的可视化" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-different-image-digest-in-console-and-on-hub" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html" class="article-date">
  <time class="dt-published" datetime="2021-11-25T03:48:29.000Z" itemprop="datePublished">2021-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/25/different-image-digest-in-console-and-on-hub.html">为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个问题困扰自己很久了，今天终于搞明白了。</p>
<p>复现： 在 Docker Hub 查看 alpine 的镜像信息，并在主机上执行 <code>docker pull alpine:3.12</code><br>问题： 在网站上看到的 <code>Digest</code> 和控制台里显示的 <code>Digest</code> 不一样</p>
<p>控制台显示的 <code>Digest</code> 是 <code>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3.12: Pulling from library/alpine</span><br><span class="line">Digest: sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</span><br><span class="line">Status: Image is up to <span class="built_in">date</span> <span class="keyword">for</span> alpine:3.12</span><br><span class="line">docker.io/library/alpine:3.12</span><br></pre></td></tr></table></figure>

<p>这个 <code>Digest</code> 并不在 alpine:3.12 官方仓库对应不同平台的<a target="_blank" rel="noopener" href="https://hub.docker.com/_/alpine?tab=tags&page=1&name=3.12">镜像列表</a> 里</p>
<table>
<thead>
<tr>
<th>DIGEST</th>
<th>OS&#x2F;ARCH</th>
<th>COMPRESSED SIZE</th>
</tr>
</thead>
<tbody><tr>
<td>7893969ec350</td>
<td>linux&#x2F;386</td>
<td>2.67 MB</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://hub.docker.com/layers/alpine/library/alpine/3.12/images/sha256-74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18">74e5ad84a67e</a></td>
<td>linux&#x2F;amd64</td>
<td>2.68 MB</td>
</tr>
<tr>
<td>8a6e4b2093ee</td>
<td>linux&#x2F;arm&#x2F;v6</td>
<td>2.49 MB</td>
</tr>
<tr>
<td>45a18fc6f681</td>
<td>linux&#x2F;arm&#x2F;v7</td>
<td>2.31 MB</td>
</tr>
<tr>
<td>29ba524fa7f5</td>
<td>linux&#x2F;arm64&#x2F;v8</td>
<td>2.59 MB</td>
</tr>
<tr>
<td>08340ab4a605</td>
<td>linux&#x2F;ppc64le</td>
<td>2.69 MB</td>
</tr>
<tr>
<td>9a7276e7579f</td>
<td>linux&#x2F;s390x</td>
<td>2.46 MB</td>
</tr>
</tbody></table>
<p>那么这两个 <code>Digest</code>，到底以那个为准呢</p>
<ul>
<li>d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</li>
<li>74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18</li>
</ul>
<p>试着都拉取一下，发现都可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull alpine@sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</span><br><span class="line">docker pull alpine@sha256:74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18</span><br></pre></td></tr></table></figure>

<p>它们对应的镜像都是 <code>alpine:3.12</code> 可以说是一样但又不完全一样。这点可以通过 <code>docker image inspect alpine:3.12</code> 验证。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b0925e0819214cd29937af66dbaf0e6fe239997faea60922cc890f9984512507&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;alpine:3.12&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RepoDigests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;alpine@sha256:74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;alpine@sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-11-12T17:20:08.442217528Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Container&quot;</span><span class="punctuation">:</span> <span class="string">&quot;385e1cc96cc7482dfb6847e293bb24baecd3f48a49791b9b45e297204b160287&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;...&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> </span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>也就是两个 <code>Digest</code> 都对应着 Docker 官方打包机在 <code>2021-11-12T17:20:08.442217528Z</code> 这个时间点打包出来的镜像的 ID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">构建链接（会被定期删除）</span><br><span class="line">https://doi-janky.infosiftr.net/job/multiarch/job/amd64/job/alpine/lastSuccessfulBuild/artifact/build-info/image-ids/alpine_3.12.txt</span><br><span class="line">镜像 ID</span><br><span class="line">sha256:b0925e0819214cd29937af66dbaf0e6fe239997faea60922cc890f9984512507</span><br></pre></td></tr></table></figure>

<p>那么不同的 <code>Digest</code> 是怎么对应同一个镜像的呢，这就要查看 Docker Registry 的 API 文档并了解 Docker 拉取镜像的原理了。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p><code>docker pull</code> 显示的是跨平台的 manifest list 的 <code>Digest</code>，而 Docker Hub 显示的是各个平台 manifest 的 <code>Digest</code>。</p>
<table>
<thead>
<tr>
<th>请求对象</th>
<th>MIME</th>
</tr>
</thead>
<tbody><tr>
<td>manifest list</td>
<td>application&#x2F;vnd.docker.distribution.manifest.list.v2+json</td>
</tr>
<tr>
<td>manifest</td>
<td>application&#x2F;vnd.docker.distribution.manifest.v2+json</td>
</tr>
</tbody></table>
<p>可以通过 curl 指定不同的 <code>Accpet</code> HTTP 请求头参数测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https://registry.mirror.aliyuncs.com/v2/library/alpine/manifests/3.12 \</span><br><span class="line">  -H <span class="string">&quot;Accept: application/vnd.docker.distribution.manifest.list.v2+json&quot;</span> -v</span><br><span class="line">  </span><br><span class="line">curl https://registry.mirror.aliyuncs.com/v2/library/alpine/manifests/3.12 \</span><br><span class="line">  -H <span class="string">&quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot;</span> -v</span><br></pre></td></tr></table></figure>

<h3 id="Manifest-List"><a href="#Manifest-List" class="headerlink" title="Manifest List"></a>Manifest List</h3><p>Response Header</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Content-Type:</span> <span class="string">application/vnd.docker.distribution.manifest.list.v2+json</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">1638</span></span><br><span class="line"><span class="attr">Docker-Content-Digest:</span> <span class="string">sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280</span></span><br><span class="line"><span class="attr">Docker-Distribution-Api-Version:</span> <span class="string">registry/2.0</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">&quot;sha256:d9459083f962de6bd980ae6a05be2a4cf670df6a1d898157bceb420342bec280&quot;</span></span><br></pre></td></tr></table></figure>

<p>Response Body</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:8a6e4b2093eee6246fdd5181cfcad4b587db1068c93315ccf5366f79d8117485&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v6&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;...&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Manifest"><a href="#Manifest" class="headerlink" title="Manifest"></a>Manifest</h3><p>Response Header</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Content-Type:</span> <span class="string">application/vnd.docker.distribution.manifest.v2+json</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">528</span></span><br><span class="line"><span class="attr">Docker-Content-Digest:</span> <span class="string">sha256:74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18</span></span><br><span class="line"><span class="attr">Docker-Distribution-Api-Version:</span> <span class="string">registry/2.0</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">&quot;sha256:74e5ad84a67e9b8ed7609b32dc2460b76175020923d7f494a73a851446222d18&quot;</span></span><br></pre></td></tr></table></figure>

<p>Response Body</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.container.image.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1471</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b0925e0819214cd29937af66dbaf0e6fe239997faea60922cc890f9984512507&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2809473</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:8572bc8fb8a32061648dd183b2c0451c82be1bd053a4ea8fae991436b92faebb&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/11/25/different-image-digest-in-console-and-on-hub.html" data-id="cm014jhwx0004psq61y93brnk" data-title="为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-kubernetes-resources" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/12/kubernetes-resources.html" class="article-date">
  <time class="dt-published" datetime="2021-07-12T03:27:21.000Z" itemprop="datePublished">2021-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/12/kubernetes-resources.html">Kubernetes 资源分配</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近遇到了 Kubernetes 上的 Web 应用响应时间长尾的问题，上网收集资料，分析了一下原因。</p>
<ul>
<li>CGroup 节流导致 Web 请求相应时间增加</li>
<li>当前执行的 CPU 不断变动</li>
<li>核数越多 CGroup 补偿碎片越严重</li>
<li>跨越 NUMA 节点</li>
</ul>
<h2 id="请求和限制计算资源"><a href="#请求和限制计算资源" class="headerlink" title="请求和限制计算资源"></a>请求和限制计算资源</h2><p>Kubernetes 对资源的细粒度管理功能可以说是吸引传统应用上 Kubernetes 的重要原因之一</p>
<p>我们在定义 Pod 的时候通过以下两个字段可以控制计算资源的分配：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests</code></td>
<td>请求的最少资源</td>
</tr>
<tr>
<td><code>limits</code></td>
<td>资源限制</td>
</tr>
</tbody></table>
<ul>
<li>当 <code>requests</code> 无法满足时，<code>Pod</code> 会一直停在 <code>Pending</code> 状态，触发 <code>FailedScheduling</code> 事件</li>
<li>当使用内存资源超过 <code>limits</code> 时，如果有其他 POD 需要内存，则使用内存最多的容器会被 <code>sacrifice</code>，触发 <code>OOMKilled</code> 事件</li>
<li>如果不指定 <code>limits</code> , 在没有命名空间默认值的情况下可以无限制地使用资源</li>
<li>如果指定了 <code>limits</code> , 但是没有指定 <code>requests</code> , 则 <code>requests</code> 值默认为 <code>limits</code> 值</li>
<li>从分配角度讲 <code>CPU</code> 属于可以压缩的资源、内存属于不可以压缩的资源</li>
</ul>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">memory-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mem-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory-demo-ctr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">polinux/stress</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;stress&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;--vm&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;--vm-bytes&quot;</span>, <span class="string">&quot;150M&quot;</span>, <span class="string">&quot;--vm-hang&quot;</span>, <span class="string">&quot;1&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="命名空间默认值、最小值和最大值"><a href="#命名空间默认值、最小值和最大值" class="headerlink" title="命名空间默认值、最小值和最大值"></a>命名空间默认值、最小值和最大值</h2><p>有些 Kubernetes 集群环境下会出现这样的问题：定义 Pod 的时候明明没有给计算资源的限制，但是在实际运行的 Pod 上出现了资源限制的定义。</p>
<p>这很有可能是命名空间的默认值造成的。 通过 <code>LimitRange</code> 对象可以设置命名空间资源的默认值、最小值和最大值。</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>default</td>
<td><code>limit</code></td>
</tr>
<tr>
<td>defaultRequest</td>
<td><code>request</code></td>
</tr>
<tr>
<td>min</td>
<td>最小值</td>
</tr>
<tr>
<td>max</td>
<td>最大值</td>
</tr>
<tr>
<td>maxLimitRequestRatio</td>
<td>比率</td>
</tr>
<tr>
<td>type</td>
<td>对象</td>
</tr>
</tbody></table>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">mem-min-max-demo-lr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod-服务质量"><a href="#Pod-服务质量" class="headerlink" title="Pod 服务质量"></a>Pod 服务质量</h2><p>当系统资源不足时就会有 Pod 遭殃，但是那么多 Pod 怎么知道要干掉哪一个呢。这就和 Pod 的服务质量有关。</p>
<p>查看运行中的 <code>Pod</code> 会有一个 <code>qosClass</code> 字段，它有以下三种取值：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Guaranteed</td>
<td>被保证的，优先级最高，除非超过限制不然不会被干掉</td>
</tr>
<tr>
<td>Burstable</td>
<td>允许突发，位于中间, 当系统资源不足且没有 <code>Best-Effort</code> 级别时</td>
</tr>
<tr>
<td>BestEffort</td>
<td>尽力保证，优先级最低，当系统资源不足时最先被干掉</td>
</tr>
</tbody></table>
<p>需要注意 <code>qosClass</code> 的值无法直接设置，而是通过 <code>requests</code> 和 <code>limits</code> 组合隐式设置</p>
<h3 id="Guaranteed"><a href="#Guaranteed" class="headerlink" title="Guaranteed"></a>Guaranteed</h3><ul>
<li>Pod 中的每个容器都要指定 CPU 请求和限制，并且两者相等</li>
<li>Pod 中的每个容器都要指定内存请求和限制，并且两者相等</li>
</ul>
<h3 id="Burstable"><a href="#Burstable" class="headerlink" title="Burstable"></a>Burstable</h3><ul>
<li>Pod 不符合 Guaranteed QoS 类的标准</li>
<li>Pod 至少有一个容器具有 CPU 或内存请求</li>
</ul>
<h3 id="BestEffort"><a href="#BestEffort" class="headerlink" title="BestEffort"></a>BestEffort</h3><ul>
<li>没有 CPU、内存请求和限制</li>
</ul>
<h2 id="CPU-管理策略"><a href="#CPU-管理策略" class="headerlink" title="CPU 管理策略"></a>CPU 管理策略</h2><p>在现代操作系统的设计下，负载运行可能会不断地迁移到不同的 CPU 核心，Kubernetes 上也是一样。</p>
<p>Kubernetes 提供了 CPU 管理策略来实现负载和 CPU 核的绑定。</p>
<p>通过 kubelet 参数 <code>--cpu-manager-policy</code> 来指定 CPU 管理策略。</p>
<table>
<thead>
<tr>
<th>取值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>none</td>
<td>默认策略，按照 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E5%85%AC%E5%B9%B3%E6%8E%92%E7%A8%8B%E5%99%A8">CFS</a> 来执行调度</td>
</tr>
<tr>
<td>static</td>
<td>允许为节点上具有某些资源特征的 Pod 赋予增强的 CPU 亲和性和独占性</td>
</tr>
</tbody></table>
<p>为了将 Pod 绑定到 CPU 需要</p>
<ul>
<li>Kubelet 开启 <code>--cpu-manager-policy static</code></li>
<li>Pod 的服务优先级为 <code>Guaranteed</code></li>
<li>Pod 的 CPU 资源为整数</li>
</ul>
<p>例如，下面的 Nginx Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;200Mi&quot;</span><br><span class="line">        cpu: &quot;2&quot;</span><br></pre></td></tr></table></figure>

<p>在运行时可独占两颗 CPU</p>
<h2 id="NUMA-和拓扑管理策略"><a href="#NUMA-和拓扑管理策略" class="headerlink" title="NUMA 和拓扑管理策略"></a>NUMA 和拓扑管理策略</h2><p>NUMA 是系统优化的一个常用思路，它是伴随着多处理器出现的一个问题。</p>
<blockquote>
<p>非统一内存访问架构（英语：Non-uniform memory access，简称NUMA）是一种为多处理器的电脑设计的内存架构，内存访问时间取决于内存相对于处理器的位置。</p>
</blockquote>
<p>常见的硬件有</p>
<ul>
<li>CPU</li>
<li>Memory</li>
<li>GPU</li>
<li>NIC</li>
</ul>
<p>安装 <code>numactl</code> 后可以通过下面的命令查看主机的 NUMA 相关信息</p>
<p><code>numactl --harware</code></p>
<p>通过下面的命令查看 NUMA 的统计信息</p>
<p><code>numastat</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">numa_hit       | Number of pages allocated from the node the process wanted.</span><br><span class="line">numa_miss      | Number of pages allocated from this node, but the process preferred another node.</span><br><span class="line">numa_foreign   | Number of pages allocated another node, but the process preferred this node.</span><br><span class="line">local_node     | Number of pages allocated from this node while the process was running locally.</span><br><span class="line">other_node     | Number of pages allocated from this node while the process was running remotely (on another node).</span><br><span class="line">interleave_hit | Number of pages allocated successfully with the interleave strategy.</span><br></pre></td></tr></table></figure>

<p>以上指标均可以通过 Telegraf 监控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.kernel_vmstat]]</span><br></pre></td></tr></table></figure>

<p><code>--cpu-manager-policy static --topology-manager-scope pod --topology-manager-policy single-numa-node</code></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-cpu-resource/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/">https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/">https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/">https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/">https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/07/12/kubernetes-resources.html" data-id="cm014jhx6000upsq616zpc6yx" data-title="Kubernetes 资源分配" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-istio-response-flags" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/21/istio-response-flags.html" class="article-date">
  <time class="dt-published" datetime="2021-04-21T07:40:35.000Z" itemprop="datePublished">2021-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/21/istio-response-flags.html">Istio 请求响应标志</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>整理了一下 Istio 的 Response Flags</p>
<p><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-response-flags">介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy/blob/v1.18.2/source/common/stream_info/utility.h#L21">源码</a></p>
<table>
<thead>
<tr>
<th>协议</th>
<th>缩写</th>
<th>备注</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP</td>
<td>DC</td>
<td>DOWNSTREAM_CONNECTION_TERMINATION</td>
<td>Downstream connection termination.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DI</td>
<td>DELAY_INJECTED</td>
<td>The request processing was delayed for a period specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>DPE</td>
<td>DOWNSTREAM_PROTOCOL_ERROR</td>
<td>The downstream request had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>FI</td>
<td>FAULT_INJECTED</td>
<td>The request was aborted with a response code specified via fault injection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>IH</td>
<td>INVALID_ENVOY_REQUEST_HEADERS</td>
<td>The request was rejected because it set an invalid value for a strictly-checked header in addition to 400 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LH</td>
<td>FAILED_LOCAL_HEALTH_CHECK</td>
<td>Local service failed health check request in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>LR</td>
<td>LOCAL_RESET</td>
<td>Connection local reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NC</td>
<td>NO_CLUSTER_FOUND</td>
<td>Upstream cluster not found.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>NR</td>
<td>NO_ROUTE_FOUND</td>
<td>No route configured for a given request in addition to 404 response code, or no matching filter chain for a downstream connection.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RL</td>
<td>RATE_LIMITED</td>
<td>The request was ratelimited locally by the HTTP rate limit filter in addition to 429 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>RLSE</td>
<td>RATELIMIT_SERVICE_ERROR</td>
<td>The request was rejected because there was an error in rate limit service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>SI</td>
<td>STREAM_IDLE_TIMEOUT</td>
<td>Stream idle timeout in addition to 408 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UAEX</td>
<td>UNAUTHORIZED_EXTERNAL_SERVICE</td>
<td>The request was denied by the external authorization service.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UC</td>
<td>UPSTREAM_CONNECTION_TERMINATION</td>
<td>Upstream connection termination in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UF</td>
<td>UPSTREAM_CONNECTION_FAILURE</td>
<td>Upstream connection failure in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UH</td>
<td>NO_HEALTHY_UPSTREAM</td>
<td>No healthy upstream hosts in upstream cluster in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UMSDR</td>
<td>UPSTREAM_MAX_STREAM_DURATION_REACHED</td>
<td>The upstream request reached to max stream duration.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>UO</td>
<td>UPSTREAM_OVERFLOW</td>
<td>Upstream overflow (circuit breaking) in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UPE</td>
<td>UPSTREAM_PROTOCOL_ERROR</td>
<td>The upstream response had an HTTP protocol error.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UR</td>
<td>UPSTREAM_REMOTE_RESET</td>
<td>Upstream remote reset in addition to 503 response code.</td>
</tr>
<tr>
<td>HTTP&#x2F;TCP</td>
<td>URX</td>
<td>UPSTREAM_RETRY_LIMIT_EXCEEDED</td>
<td>The request was rejected because the upstream retry limit (HTTP) or maximum connect attempts (TCP) was reached.</td>
</tr>
<tr>
<td>HTTP</td>
<td>UT</td>
<td>UPSTREAM_REQUEST_TIMEOUT</td>
<td>Upstream request timeout in addition to 504 response code.</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/21/istio-response-flags.html" data-id="cm014jhx5000ppsq67sabgdzu" data-title="Istio 请求响应标志" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/istio/" rel="tag">istio</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-containerized-jvm-parameters" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/13/containerized-jvm-parameters.html" class="article-date">
  <time class="dt-published" datetime="2021-04-13T09:23:31.000Z" itemprop="datePublished">2021-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/13/containerized-jvm-parameters.html">JVM 对容器化支持的参数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>阅读本文你需要了解</p>
<ul>
<li>JVM 的启动参数</li>
<li>容器的启动参数</li>
</ul>
<h3 id="JVM-启动参数"><a href="#JVM-启动参数" class="headerlink" title="JVM 启动参数"></a>JVM 启动参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>-Xms</code></td>
<td>MiniumHeapSize</td>
</tr>
<tr>
<td><code>-Xmx</code></td>
<td>MaxHeapSize</td>
</tr>
<tr>
<td><code>-Xss</code></td>
<td>StackSize</td>
</tr>
</tbody></table>
<p>在容器化之前一般由运维工程师根据部署环境机器的内存大小来调整，并写在启动脚本里</p>
<h3 id="容器启动参数"><a href="#容器启动参数" class="headerlink" title="容器启动参数"></a>容器启动参数</h3><p>在使用 k8s 编排容器的时候通常通过定义 resources 字段来限制容器使用的资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limit:</span></span><br><span class="line">     <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">     <span class="attr">memory:</span> <span class="string">1G</span></span><br></pre></td></tr></table></figure>

<p>为了方便验证，我们直接用本地 docker 来实验，docker run 命令的一些参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>–cpus</td>
<td>Number of CPUs</td>
</tr>
<tr>
<td>–cpu-period int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) period</td>
</tr>
<tr>
<td>–cpu-quota int</td>
<td>Limit CPU CFS (Completely Fair Scheduler) quota</td>
</tr>
<tr>
<td>–cpu-rt-period int</td>
<td>Limit CPU real-time period in microseconds</td>
</tr>
<tr>
<td>–cpu-rt-runtime int</td>
<td>Limit CPU real-time runtime in microseconds</td>
</tr>
<tr>
<td>–cpu-shares int</td>
<td>CPU shares (relative weight)</td>
</tr>
<tr>
<td>–memory</td>
<td>Memory limit</td>
</tr>
</tbody></table>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>容器化的 JVM 程序会遇到这几个问题</p>
<ul>
<li>问题 1： 超过了容器的资源限制被 OOM 机制杀掉</li>
<li>问题 2： 在核数比较高的机器上 JVM 频繁 GC</li>
</ul>
<h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题 1"></a>问题 1</h3><p>JDK 8u191 之前这个问题很常见，主要是由于 JVM 获得的最大内存是主机的最大内存而不是容器的最大可用内存，解决方法是修改启动逻辑。<br>让 JVM 能够获取到正确的最大可用内存</p>
<h3 id="问题-2"><a href="#问题-2" class="headerlink" title="问题 2"></a>问题 2</h3><p>ParallelGC 线程数如果过高会导致 GC 过于频繁，和问题1 类似，这是由于 JVM 获得的可用核数不正确导致的。</p>
<p>为了解决这两个需要同时修改容器的资源限制和 JVM 的启动参数，并使之相匹配。<br>当然也有一种不那么笨的做法是引入一个动态的启动脚本，先根据容器的实际资源限制算出对应的 JVM 参数再去启动 JVM。<br>JDK 社区已经注意到以上这几个容器化常遇到的问题并在新的 JDK 版本里解决了，由于 JDK8 的超长待机时间，以下便以 JDK8 为例</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>GA 时间</th>
<th>验证镜像</th>
<th>容器化支持</th>
</tr>
</thead>
<tbody><tr>
<td><code>8u191</code></td>
<td><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/8u191-relnotes.html">2018-10-16</a></td>
<td>openjdk:8u191-alpine</td>
<td>支持</td>
</tr>
<tr>
<td><code>8u131</code></td>
<td><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/8u131-relnotes.html">2017-04-18</a></td>
<td>openjdk:8u131-alpine</td>
<td>实验性支持</td>
</tr>
<tr>
<td><code>8u121</code></td>
<td><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/8u121-relnotes.html">2017-01-17</a></td>
<td>openjdk:8u121-alpine</td>
<td>不支持</td>
</tr>
</tbody></table>
<h2 id="识别-CPU-资源"><a href="#识别-CPU-资源" class="headerlink" title="识别 CPU 资源"></a>识别 CPU 资源</h2><p>实验： 通过 <code>ParallelGCThreads</code> 是否符合预期来验证 JDK 对 CPU 资源的识别是否正确</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal -XX:+UseParallelGC -version | grep -i ParallelGCThreads</span><br></pre></td></tr></table></figure>

<h3 id="8u191-之前不支持"><a href="#8u191-之前不支持" class="headerlink" title="8u191 之前不支持"></a>8u191 之前不支持</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --cpus 1 --rm openjdk:8u121-alpine java -XX:+PrintFlagsFinal -XX:+UseParallelGC -version | grep -i ParallelGCThreads</span><br></pre></td></tr></table></figure>

<p>结果不符合预期，结果为主机核数</p>
<h3 id="8u191-支持识别可用-CPU-核数"><a href="#8u191-支持识别可用-CPU-核数" class="headerlink" title="8u191 支持识别可用 CPU 核数"></a>8u191 支持识别可用 CPU 核数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --cpus 1 --rm openjdk:8u191-alpine java -XX:+PrintFlagsFinal -XX:+UseParallelGC -version | grep -i ParallelGCThreads</span><br></pre></td></tr></table></figure>

<p>结果符合预期，结果为 1</p>
<h3 id="8u191-关闭自动识别可用-CPU-核数"><a href="#8u191-关闭自动识别可用-CPU-核数" class="headerlink" title="8u191 关闭自动识别可用 CPU 核数"></a>8u191 关闭自动识别可用 CPU 核数</h3><p>在分到 4 个 CPU 核数的情况下，指定可用 CPU 核数为 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --cpus 4 --rm openjdk:8u191-alpine java -XX:+PrintFlagsFinal -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -version | grep -i ParallelGCThreads</span><br></pre></td></tr></table></figure>

<p>结果符合预期，结果为 1</p>
<h2 id="识别-Memory-资源"><a href="#识别-Memory-资源" class="headerlink" title="识别 Memory 资源"></a>识别 Memory 资源</h2><p>实验： 通过查看 JVM 运行时的参数来验证 JVM 对 Memory 资源的识别是否正确</p>
<p><code>java -XshowSettings:vm -version</code></p>
<h3 id="8u121-不支持"><a href="#8u121-不支持" class="headerlink" title="8u121 不支持"></a>8u121 不支持</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u121-alpine java -XshowSettings:vm -version</span><br></pre></td></tr></table></figure>

<p>结果不符合预期，结果为主机内存的 25%，这是因为这个版本 JDK 的 MaxHeapSize 计算公式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MaxHeapSize = MaxRAM / MaxRAMFraction</span><br></pre></td></tr></table></figure>

<p>其中的 <code>MaxRAM</code> <a href="">来自于主机</a></p>
<h3 id="8u131-实验性支持"><a href="#8u131-实验性支持" class="headerlink" title="8u131 实验性支持"></a>8u131 实验性支持</h3><p>直接使用 8u131 版本的 JDK 运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u131-alpine java -XshowSettings:vm -version</span><br></pre></td></tr></table></figure>

<p>结果不符合预期，说明 8u131 默认没有开启对容器化的支持，要开启需要加上实验性参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u131-alpine java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XshowSettings:vm -version</span><br></pre></td></tr></table></figure>

<p>结果符合预期</p>
<h3 id="8u191-默认支持"><a href="#8u191-默认支持" class="headerlink" title="8u191 默认支持"></a>8u191 默认支持</h3><p>使用 8u191 版本运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u191-alpine java -XshowSettings:vm -version</span><br></pre></td></tr></table></figure>

<p>结果符合预期</p>
<h3 id="8u191-关闭自动识别最大可用内存"><a href="#8u191-关闭自动识别最大可用内存" class="headerlink" title="8u191 关闭自动识别最大可用内存"></a>8u191 关闭自动识别最大可用内存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u191-alpine java -XX:-UseContainerSupport -XshowSettings:vm -version</span><br></pre></td></tr></table></figure>

<p>结果符合预期，结果为主机内存的 25%</p>
<h2 id="JVM-容器化相关参数"><a href="#JVM-容器化相关参数" class="headerlink" title="JVM 容器化相关参数"></a>JVM 容器化相关参数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100M --rm openjdk:8u191-alpine java \</span><br><span class="line">  -XX:+UnlockExperimentalVMOptions \</span><br><span class="line">  -XX:+UnlockDiagnosticVMOptions \</span><br><span class="line">  -XX:+PrintFlagsFinal \</span><br><span class="line">  -XX:+UseParallelGC -version | grep -i &#x27;cgroup\|container\|parallelgcthreads&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="ActiveProcessorCount"><a href="#ActiveProcessorCount" class="headerlink" title="ActiveProcessorCount"></a>ActiveProcessorCount</h3><blockquote>
<p>Specify the CPU count the VM should use and report as active</p>
</blockquote>
<p>8U191 引入</p>
<h3 id="PrintContainerInfo"><a href="#PrintContainerInfo" class="headerlink" title="PrintContainerInfo"></a>PrintContainerInfo</h3><p>必须使用 UnlockDiagnosticVMOptions 开启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100MB --rm openjdk:8u191-alpine java -XshowSettings:vm -XX:+UnlockDiagnosticVMOptions -XX:+PrintContainerInfo -version</span><br></pre></td></tr></table></figure>

<h3 id="UseContainerSupport"><a href="#UseContainerSupport" class="headerlink" title="UseContainerSupport"></a>UseContainerSupport</h3><blockquote>
<p>Enable detection and runtime container configuration support</p>
</blockquote>
<p><code>8U191</code> 引入</p>
<h3 id="PreferContainerQuotaForCPUCount"><a href="#PreferContainerQuotaForCPUCount" class="headerlink" title="PreferContainerQuotaForCPUCount"></a>PreferContainerQuotaForCPUCount</h3><blockquote>
<p>Calculate the container CPU availability based on the value of quotas (if set), when true. Otherwise, use the CPU shares value, provided it is less than quota.</p>
</blockquote>
<h3 id="UseCGroupMemoryLimitForHeap"><a href="#UseCGroupMemoryLimitForHeap" class="headerlink" title="UseCGroupMemoryLimitForHeap"></a>UseCGroupMemoryLimitForHeap</h3><blockquote>
<p>Use CGroup memory limit as physical memory limit for heap sizing</p>
</blockquote>
<p><code>8U131</code> 引入</p>
<p>在 JDK11 中已移除，被默认开启的 <code>UseContainerSupport</code> 代替</p>
<h3 id="MinRAMFraction"><a href="#MinRAMFraction" class="headerlink" title="MinRAMFraction"></a>MinRAMFraction</h3><blockquote>
<p>Minimum fraction (1&#x2F;n) of real memory used for maximum heap  size on systems with small physical memory size.<br>Deprecated, use MinRAMPercentage instead</p>
</blockquote>
<p><code>8U131</code> 引入 <code>8U191</code> 移除</p>
<h3 id="MaxRAMFraction"><a href="#MaxRAMFraction" class="headerlink" title="MaxRAMFraction"></a>MaxRAMFraction</h3><blockquote>
<p>Maximum fraction (1&#x2F;n) of real memory used for maximum heap size.                                                          <br>Deprecated, use MaxRAMPercentage instead</p>
</blockquote>
<p><code>8U131</code> 引入 <code>8U191</code> 移除</p>
<h3 id="InitialRAMPercentage"><a href="#InitialRAMPercentage" class="headerlink" title="InitialRAMPercentage"></a>InitialRAMPercentage</h3><blockquote>
<p>Percentage of real memory used for initial heap size</p>
</blockquote>
<p><code>8U191</code> 引入</p>
<h3 id="MaxRAMPercentage"><a href="#MaxRAMPercentage" class="headerlink" title="MaxRAMPercentage"></a>MaxRAMPercentage</h3><blockquote>
<p>Maximum percentage of real memory used for maximum heap size</p>
</blockquote>
<p>MaxRAMPercentage 在可用内存大于 250MB 时生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 1000MB --rm openjdk:8u212-alpine java -XshowSettings:vm -XX:MaxRAMPercentage=50.0 -XX:MinRAMPercentage=50.0 -version</span><br></pre></td></tr></table></figure>

<h3 id="MinRAMPercentage"><a href="#MinRAMPercentage" class="headerlink" title="MinRAMPercentage"></a>MinRAMPercentage</h3><blockquote>
<p>Minimum percentage of real memory used for maximum heap size on systems with small physical memory size</p>
</blockquote>
<p>MaxRAMPercentage 和 MaxRAMPercentage 都是用来计算 MaxHeapSize 的</p>
<p>MinRAMPercentage 在可用内存小于 250MB 时生效 （实际很少除非 IoT 设备）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 200MB --rm openjdk:8u212-alpine java -XshowSettings:vm -XX:MaxRAMPercentage=50.0 -XX:MinRAMPercentage=50.0 -version</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://dzone.com/articles/difference-between-initialrampercentage-minramperc">https://dzone.com/articles/difference-between-initialrampercentage-minramperc</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/04/13/containerized-jvm-parameters.html" data-id="cm014jhwz0007psq6evfpfqhr" data-title="JVM 对容器化支持的参数" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tencentyun" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/18/tencentyun.html" class="article-date">
  <time class="dt-published" datetime="2021-03-18T05:28:28.000Z" itemprop="datePublished">2021-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/18/tencentyun.html">腾讯软件源</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo</span><br><span class="line">sed -i &#x27;s/cloud\.tencent\.com/tencentyun\.com/1&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2021/03/18/tencentyun.html" data-id="cm014jhxj0020psq6akoxf5a8" data-title="腾讯软件源" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-letsencrypt-root-ca" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/18/letsencrypt-root-ca.html" class="article-date">
  <time class="dt-published" datetime="2020-09-18T05:22:00.000Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/18/letsencrypt-root-ca.html">[译] Let&#39;s Encrypt 的新根证书和中间证书</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://letsencrypt.org/2020/09/17/new-root-and-intermediates.html">原文</a></p>
<p>在 2020 年 9 月 30 日这天，Let’s Encrypt 颁发了六个新证书：一个根证书，四个中间证书和一个交叉证书。这些证书属于改善网络隐私的更大计划的一部分，让 ECDSA 终端证书被更广泛的采纳，和更小的证书体积。</p>
<p>鉴于我们每天要颁发 150 万张证书，这些证书有什么特别？为什么颁发它们？怎么颁发它们？让我们通过解释 CA 是如何思考和工作的来回答这些问题。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>每一个被公众信任的 CA (例如 Let’s Encrypt) 都至少有一个根证书被众多的浏览器和操作系统 (例如 Mozilla 和 Google) 的信任跟存储所包含。通过这种方式，用户可以确认他们从网站收到的证书是一个被浏览器信任的机构所颁发的。但是根证书由于它们的广泛传播以及较长的信赖周期，它的秘钥必须被妥善的保护并离线保管，以防止被用来不停地签发。因此 CA 会有若干个中间证书来替代根证书以确保证日常安全。</p>
<p>最近 5 年里， Let’s Encrypt 只有一个根证书： ISRG Rott X1，它拥有一个 4096 位的 RSA 秘钥并且有效期直到 2035 年。</p>
<p>也是在这段时间里，我们有了四个中间证书，分别是 Let’s Encrypt Authorities X1, X2, X3 和 X4。 前两个是 Let’s Encrypt 刚开始运营的 2015 年颁发的，有效期为 5 年；后两个是一年后，也就是 2016 年颁发的，有效期 5 年，并将在明年的这个时候过期。所有的这些中间证书都使用 2048 位的秘钥。此外，这些中间证书都由 IdenTrust 公司的 DST Root CA X3 根证书交叉签署，这个证书由另一家广泛被信任的 CA 所管理。</p>
<p>Let’s Encrypt 到 2020 年 8 月的结构图</p>
<p><img src="/images/2020/letsencrypt-aug-2020.png" alt="8月"></p>
<h2 id="新证书"><a href="#新证书" class="headerlink" title="新证书"></a>新证书</h2><p>首先，我们颁发了两个 2048 位秘钥的 RSA 中间证书：R3 和 R4. 这两个证书都由 ISRG Root X1 签署，拥有 5 年的有效期。同样交由 IdentTrust 交叉签署。它们实际上是 X3 和 X4 的直接替代，考虑到它们一年后即将到期。我们预计会在今年底把主要的证书颁发流水线切换到使用 R3 证书，不会对证书的颁发和续签的造成实际的影响。</p>
<p>另一个新证书更有意思一点。首先，我们有了一个新的 ISRG Root X2，将会使用 ECDSA P-384 替代 RSA，有效期到 2040 年。由它颁发了两个新的中间证书：E1 和 E2，签名算法也是 ECDSA 并且有效期为 5 年。</p>
<p>值得注意的是，这些新中间证书并没交由 IdentTrust 的 DST Root CA X3 交叉签署, ISRG Root X2 本身由 ISRG Root X1 交叉签署。敏锐的观察者可能也会注意到我们没有通过  ISRG Root X2 颁发有 OCSP 签名的证书。</p>
<p>Let’s Encrypt 到 2020 年 9 月的结构图</p>
<p><img src="/images/2020/letsencrypt-sept-2020.png" alt="9月"></p>
<p>既然已经讨论到了技术细节，不妨再深入了解下这个结构的由来。</p>
<h2 id="为什么颁发-ECDSA-的根证书和中间证书"><a href="#为什么颁发-ECDSA-的根证书和中间证书" class="headerlink" title="为什么颁发 ECDSA 的根证书和中间证书"></a>为什么颁发 ECDSA 的根证书和中间证书</h2><p>已经有好多文章讨论过 ECDSA 的好处 (相同加密程度下更小的秘钥，更快的加密，解密，签名，验证等操作)。不过对我们来说，更大的好处来自于证书体积的缩小。</p>
<p>每一个通过 <code>https://</code> 到远程主机的链接都需要一次 TLS 握手。每一个 TLS 握手都需要服务器提供它的证书。校验证书的过程还包括检查证书链（包括直到可信根证书的所有中间证书），这通常也是由有服务器提供的。这就意味这每个链接，一个覆盖各种广告和跟踪像素的页面会包含几十甚至上百个链接，这会需要传输大量的证书数据。并且每个证书都包含自己的公钥和签发者的签名。</p>
<p>一个 2048 位的 RSA 公钥大概 256 字节，而一个 ECDSA P-284 的公钥只有 48 字节。类似的， RSA 的签名会需要额外的 256 字节，而 ECDSA 只需要 96 字节。再考虑到其他一些开销，每个证书能节约大约 400 字节。用这个数乘以你的证书链长度以及每天的链接数，带宽的节省就很可观了。</p>
<p>这些省下的流量不仅会使我们的证书使用者每月节省大量的带宽费用，也惠及那些有限的、受限的终端用户。提高整个互联网的隐私性不仅是采用证书技术，也包括这让这些技术更经济。</p>
<p>此外由于我们很关心证书的大小，我们还采取了一些其它手段来让证书变得更小。我们把证书的主体名字由 “Let’s Encrypt Authority X3” 缩减到 “R3”，这是给予机构名称里已经提供了冗余的 “Let’s Encrypt”。同时我们还缩短了 Authority Information Access Issuer 和 CRL Distribution Point 的 URL 长度，我们还整个砍掉了 CPS 和 OCSP 的 URL。通过这些手段我们能够在不丢失实质性信息的情况下让证书再缩小 120 字节。</p>
<h2 id="为什么交叉签署-ECDSA-根证书"><a href="#为什么交叉签署-ECDSA-根证书" class="headerlink" title="为什么交叉签署 ECDSA 根证书"></a>为什么交叉签署 ECDSA 根证书</h2><p>交叉签署是新根证书从被签发到被主流信任的过渡阶段很重要的步骤。我们知道 ISRG Root X2 可能需要 5 年甚至更长时间才能被广泛接受，所以 E1 中间证书签发的证书如果希望被信任，一定需要证书链中某处的交叉签署。</p>
<p>我们基本上有两种方法：用现有的 ISRG Root X1 交叉签署 ISRG Root X2，或者用 ISRG Root X1 直接交叉签署 E1 和 E2。接下来我们就来分析下这两种做法分别有什么优缺点。</p>
<p>交叉签署 ISRG Root X2 意味着如果一个用户在信任库里有 ISRG Root X2，那么该证书链就是 100% ECDSA ，可以利用前文所述的快速校验。并且在接下来的几年里随着 ISRG Root X2 被加到越来越多的信任库里，ECDSA 终端证书的验证会越来越快而不需要用户或者网站做什么。这么做的代价是，只要 X2 还不在信任库里，用户的客户端就需要验证两个中间证书包括 E1 和 X2 直到 X1 根证书。这显然增加了证书验证的时间。</p>
<p>直接交叉新签署中间证书也有问题。一方面所有证书链的长度是相同的，在证书使用者和被广泛信任的 ISRG Root X1 之间只有一个中间证书。但是另一方面，随着 ISRG Root X2 获得越来越广泛的的信任，我们需要通过切换到另外一个链来<br>保证所有都能享受全链 ECDSA 的好处。</p>
<p>最终我们认为全链 ECDSA 更重要，所以我们选择了第一个方案，交叉签署 ISRG Root X2 证书。</p>
<h2 id="为什么我们不提供-OCSP-Responder-了"><a href="#为什么我们不提供-OCSP-Responder-了" class="headerlink" title="为什么我们不提供 OCSP Responder 了"></a>为什么我们不提供 OCSP Responder 了</h2><p>OCSP 协议是用户客户端用来发现并实时检查证书是否被吊销的一种方式。无论何时，一个浏览器如果想要知道证书是否有效，它可以通过访问证书里的一个 URL 就能得到是或否的答案，这个结果是由另一个可以被用相同方式检查的证书签名。这对终端用户的证书来说是非常棒的，应为请求响应体积很小并且速度很快。根据访问的站点不同，任何一个用户可能会关心（因此必须下载）海量证书集合的有效性。</p>
<p>但是中间证书只是海量证书的一个小小的子集，并且通常是广为人知的，也很少被吊销。因此，提供一个所有常用中间证书的吊销列表可能会更有效。我们的中间证书都包括一个 URL，通过这个 URL 浏览器可以下载证书的 CRl。实际上有些浏览器甚至会在例行更新里带上 CRL 列表集合，这使得在检查中间证书有效性的时候不需要再进行一次额外的访问开销，从而为大家创造更好的体验。</p>
<p>实际上用来指导 CA 的 Baseline Requirements 最近一次更新表明，中间证书已经不再强制要求包含一个 OCSP URL，而是可以只通过 CRL 来发布自己的吊销信息。鉴于此，我们从中间证书里移除了 OCSP URL，即我们不再需要为所有 ISRG Root X2 颁发的中间证书提供 OCSP Responder。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此我们已经介绍了新证书，最后再提一点：我们是怎么颁发这些证书的。</p>
<p>创建新根证书和中间证书是一个大事件，因为它们是被监管的的并且需要极其小心地看管好秘钥。这个事件是如此重要以至于颁发新证书被称作是“仪式”。在 Let’s Encrypt 我们非常推崇机器自动化，所以我们想要这个仪式的人为干预越少越好。</p>
<p>在过去的几个月里我们为这个仪式建立了一个工具，如果输入正确的配置，就能够生成所需的秘钥、证书和交叉签名请求等。我们还建立了一个仪式的 Demo 来说明这个配置文件可以并且允许所有人来运行和检查结果。我们的 SRE 搭建了一个相同并配有硬件安全模块的网络，自己执行了若干次仪式以确保整个流程完美无暇。我们与技术委员会、社区和若干邮件列表分享了这个 Demo，在这个过程中获得了很多有价值的反馈，其中一些甚至影响了上面我们提到的一些决定。最终、在 2020 年 9 月 3 号，我们的执行董事和 SRE 在一个安全的数据中心碰面并执行了整个仪式，并且有录像以供审计用。</p>
<p>现在仪式已经完成。我们已经更新了证书页面上关于新证书的细节，并且开始着手于申请将我们的新根证书加入到若干个信任库中。我们会在未来几周里开始用新中间证书来签发证书，并在社区论坛里发布进一步的公告。</p>
<p>希望我们关于新证书结构的导览是有趣的和干货的。我们期待继续通过一张张的证书来改进互联网隐私。我们由衷感谢 IdenTrust 在早期和后来不间断的支持我们让互联网更安全的愿景。</p>
<p>我们依靠社区和支持者来提供我们的服务。如果你的公司或者机构希望可以赞助 Let’s Encrypt 可以发邮件到 sponsor#letsencrypt.org 。我们需要您力所能及的帮助、</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2020/09/18/letsencrypt-root-ca.html" data-id="cm014jhx7000xpsq67n4ifs5y" data-title="[译] Let&#39;s Encrypt 的新根证书和中间证书" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pki/" rel="tag">pki</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jira-internal-and-ldap" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/12/jira-internal-and-ldap.html" class="article-date">
  <time class="dt-published" datetime="2020-08-12T02:56:34.000Z" itemprop="datePublished">2020-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/12/jira-internal-and-ldap.html">JIRA 内置用户目录与 LDAP 的关系</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>作为运维开发怎么能不折腾一下 JIRA 呢。JIRA 支持从多个来源获取用户信息，默认的是内置用户目录，一个比较常见需求是改用 LDAP 作为用户目录，特别适合公司里有多个账号体系的情况。</p>
<p>如果想了解其中的细节最好方式还是搭个独立的测试环境，主要是 Jira, OpenLDAP 和 MySQL，可以用一个 docker-compose 搞定。安装和配置部分略去，以下直接给出分析过程：</p>
<h2 id="相关的表"><a href="#相关的表" class="headerlink" title="相关的表"></a>相关的表</h2><table>
<thead>
<tr>
<th>表名</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>cwd_directory</td>
<td>用户目录</td>
</tr>
<tr>
<td>cwd_group</td>
<td>用户组</td>
</tr>
<tr>
<td>cwd_user</td>
<td>用户</td>
</tr>
<tr>
<td>cwd_membership</td>
<td>用户组 -&gt;　用户</td>
</tr>
</tbody></table>
<p><strong>cwd_directory</strong></p>
<table>
<thead>
<tr>
<th>ID</th>
<th>directory_name</th>
<th>impl_class</th>
<th>directory_type</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>JIRA Internal Directory</td>
<td>com.atlassian.crowd.directory.InternalDirectory</td>
<td>INTERNAL</td>
</tr>
<tr>
<td>10000</td>
<td>My OpenLDAP</td>
<td>com.atlassian.crowd.directory.OpenLDAP</td>
<td>CONNECTOR</td>
</tr>
</tbody></table>
<p>之前看到网上有一条语句改库完成 LDAP 迁移的神操作，这个操作会假设 OpenLDAP 的库 ID 是 10000，果然是艺高人胆大。</p>
<p><strong>cwd_group</strong></p>
<table>
<thead>
<tr>
<th>ID</th>
<th>directory_id</th>
<th>group_name</th>
<th>active</th>
<th>local</th>
<th>group_type</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>1</td>
<td>jira-administrators</td>
<td>1</td>
<td>0</td>
<td>GROUP</td>
</tr>
<tr>
<td>10010</td>
<td>1</td>
<td>jira-software-users</td>
<td>1</td>
<td>0</td>
<td>GROUP</td>
</tr>
<tr>
<td>10110</td>
<td>1</td>
<td>jira-software-users</td>
<td>1</td>
<td>1</td>
<td>GROUP</td>
</tr>
</tbody></table>
<p><strong>cwd_user</strong></p>
<table>
<thead>
<tr>
<th>ID</th>
<th>directory_id</th>
<th>username</th>
<th>active</th>
<th>email_address</th>
<th>CREDENTIAL</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>1</td>
<td>root</td>
<td>1</td>
<td><a href="mailto:&#114;&#x6f;&#x6f;&#116;&#64;&#101;&#120;&#x61;&#x6d;&#112;&#108;&#101;&#x2e;&#99;&#111;&#x6d;">&#114;&#x6f;&#x6f;&#116;&#64;&#101;&#120;&#x61;&#x6d;&#112;&#108;&#101;&#x2e;&#99;&#111;&#x6d;</a></td>
<td>{PKCS5S2}********</td>
</tr>
<tr>
<td>10102</td>
<td>10000</td>
<td>foo</td>
<td>1</td>
<td><a href="mailto:&#x66;&#x6f;&#111;&#64;&#x65;&#120;&#97;&#x6d;&#x70;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#x66;&#x6f;&#111;&#64;&#x65;&#120;&#97;&#x6d;&#x70;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;</a></td>
<td>nopass</td>
</tr>
<tr>
<td>10100</td>
<td>1</td>
<td>foo</td>
<td>1</td>
<td><a href="mailto:&#102;&#x6f;&#111;&#x40;&#101;&#120;&#97;&#x6d;&#x70;&#x6c;&#x65;&#x2e;&#99;&#x6f;&#x6d;">&#102;&#x6f;&#111;&#x40;&#101;&#120;&#97;&#x6d;&#x70;&#x6c;&#x65;&#x2e;&#99;&#x6f;&#x6d;</a></td>
<td>{PKCS5S2}********</td>
</tr>
</tbody></table>
<p>迁移之前最大的顾虑就是迁移前的数据能够保存了，这块主要分两部分</p>
<ul>
<li>各种任务，评论等</li>
<li>在项目里的角色</li>
<li>用户组信息</li>
</ul>
<p>通过实验发现只要保证 internal 和 ldap 里的 username 一致 1 和 2 就可以得到保留，同样，只要保证 group_name 一致 3 就可以得到保留。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>结合表里的数据可得到以下结论：</p>
<ul>
<li>username 和 group_name 在各自的库里都是唯一的</li>
<li>从全局看 username 对应的用户只能有一个，取决于目录的优先级顺序</li>
<li>从全局看 group_name 是不同目录下的用户的集合</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2020/08/12/jira-internal-and-ldap.html" data-id="cm014jhx5000rpsq6hq4r3rqe" data-title="JIRA 内置用户目录与 LDAP 的关系" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-vagrantfile-highliting" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/09/vagrantfile-highliting.html" class="article-date">
  <time class="dt-published" datetime="2020-07-09T02:00:25.000Z" itemprop="datePublished">2020-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/09/vagrantfile-highliting.html">Pycharm 里为 Vagrantfile 如何设置语法高亮</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近又开始捣鼓 <code>Vagrant</code> 了，但是在 Pycharm (2020.1.2) 里一直没有语法高亮，明明装了 <code>Vagrant</code> 插件的。</p>
<p>还好网上搜到了这个<a target="_blank" rel="noopener" href="https://gist.github.com/boneskull/efcf2dcf265096f014d7#file-vagrantfile-xml">方法</a>，新建 <code>Vagrantfile.xml</code> 如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filetype</span> <span class="attr">binary</span>=<span class="string">&quot;false&quot;</span> <span class="attr">description</span>=<span class="string">&quot;Vagrant Configuration File&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Vagrantfile&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">highlighting</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">options</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;LINE_COMMENT&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;COMMENT_START&quot;</span> <span class="attr">value</span>=<span class="string">&quot;=begin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;COMMENT_END&quot;</span> <span class="attr">value</span>=<span class="string">&quot;=end&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;HEX_PREFIX&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;NUM_POSTFIXES&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;HAS_BRACES&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;HAS_BRACKETS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;HAS_PARENS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;HAS_STRING_ESCAPES&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keywords</span> <span class="attr">keywords</span>=<span class="string">&quot;BEGIN;END;begin;break;case;do;else;elsif;end;ensure;for;if;in;next;rescue;retry;then;until;when;while&quot;</span> <span class="attr">ignore_case</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keywords2</span> <span class="attr">keywords</span>=<span class="string">&quot;__ENCODING__;__END__;__FILE__;__LINE__&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keywords3</span> <span class="attr">keywords</span>=<span class="string">&quot;and;false;nil;not;or;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keywords4</span> <span class="attr">keywords</span>=<span class="string">&quot;class;def;module;return;self;super;undef;yield&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">highlighting</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">extensionMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">pattern</span>=<span class="string">&quot;Vagrantfile&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">extensionMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filetype</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>貌似得放到某个文件夹下，懒得找了，直接在 IDE 里设置吧：</p>
<p>进入 <code>File &gt; Settings &gt; Editor &gt; File Types</code> 对话框，在 <code>Recognized file types:</code> 里点击 <code>+</code> 号，<br>添加 <code>Vagrantfile</code> 类型即可，其它的配置参照上面 <code>Vagrantfile.xml</code> 里，</p>
<p>唯一要注意的是 <code>Keywords</code> 部分不是以 <code>;</code> 分割而是需要一行一个 <code>Keyword</code></p>
<p><strong>错误</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__ENCODING__;__END__;__FILE__;__LINE__</span><br></pre></td></tr></table></figure>

<p><strong>正确</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__ENCODING__</span><br><span class="line">__END__</span><br><span class="line">__FILE__</span><br><span class="line">__LINE__</span><br></pre></td></tr></table></figure>

<p>用这种方法还可为任何类型的文件增加语法高亮，是不是很赞！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.longtian.io/2020/07/09/vagrantfile-highliting.html" data-id="cm014jhxl0028psq65a8i8nwv" data-title="Pycharm 里为 Vagrantfile 如何设置语法高亮" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pycharm/" rel="tag">pycharm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vagrant/" rel="tag">vagrant</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%94%E8%AE%B2/">演讲</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%83%B3/">随想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/" rel="tag">devops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/" rel="tag">istio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opensource/" rel="tag">opensource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pki/" rel="tag">pki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pycharm/" rel="tag">pycharm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vagrant/" rel="tag">vagrant</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/devops/" style="font-size: 10px;">devops</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/istio/" style="font-size: 10px;">istio</a> <a href="/tags/opensource/" style="font-size: 10px;">opensource</a> <a href="/tags/pki/" style="font-size: 10px;">pki</a> <a href="/tags/pycharm/" style="font-size: 10px;">pycharm</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vagrant/" style="font-size: 10px;">vagrant</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/06/21/reading-2022.html">我的 2022 书单</a>
          </li>
        
          <li>
            <a href="/2022/02/11/how-gps-work.html">[译] GPS 工作原理的可视化</a>
          </li>
        
          <li>
            <a href="/2021/11/25/different-image-digest-in-console-and-on-hub.html">为什么 Docker Pull 显示的 Digest 和 Docker Hub 的不一样</a>
          </li>
        
          <li>
            <a href="/2021/07/12/kubernetes-resources.html">Kubernetes 资源分配</a>
          </li>
        
          <li>
            <a href="/2021/04/21/istio-response-flags.html">Istio 请求响应标志</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" />
</a></br>
All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></br>
      
      &copy; 2024 longtian<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>